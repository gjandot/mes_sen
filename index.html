<!DOCTYPE html>
<html lang="fr">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Sénateurs français : quiz et trombinoscope">
<meta name="author" content="Guillaume JANDOT">
<link rel="icon" type="image/png" href="trombico.png">
<meta charset="UTF-8">
<!--
* mode "défi" : tous les sénateurs. Arrêt à la première erreur.
* nombres de propositions
-->
<title>Mes-Sen</title>
<style>
#messen { height:420px; width:850px; margin:auto; padding:9px; border-radius:20px; background-color:#C80947; position:relative; }
#loading { font-size:1.2em; color:white; }
#citation { border:1px solid white; position:absolute; left:275px; margin:20px; background-color:#AAAAAA; padding:9px; }
#citation a { font-size:1.3em; color:black; text-decoration:none; font-family: monospace; }
#progressbar { height:50px; width:40%; margin:auto; }
#progress { width:100%; margin:auto; }
.gamesel { font-size:1.5em; position:relative; height:120px; width:250px; color:white; cursor:pointer; background-color:blue;
			border:3px solid black; margin:10px; border-radius:25px; text-align:center; line-height:120px; }
.gamesel:hover { font-size:2em; border:3px solid yellow; background-color:white; color:blue; }
.tooltip { font-size:1em; color:white; background-color:black; height:45px; width:200px;
			position:absolute; left:300px; padding:9px; text-align:center; vertical-align:middle; }
.tooltip:before { content:""; position:absolute; left:-15px; top:15px; 
			border-top:15px solid transparent; border-right:16px solid black; border-bottom:15px solid transparent; }
.clavier { font-size:0.7em; color:#BBBBBB; float:right; }

#ico_conf { position:absolute; left:780px; top:360px; cursor:pointer; }
#ico_conf:hover { transform:scale(1.1) rotate(9deg); transition:0.2s ease;
					filter:drop-shadow(2px 2px 2px white);}
#maskon { transform:scale(1.5); display:inline-block; height:50px; }
.niv_gris { filter:grayscale(1); }

#score { border:1px solid white; color:lightblue; background-color:blue; margin:9px; padding:3px; float:right; }
#temps { font-size:2em; height:40px; width:40px; border-radius:50%; text-align:center;
			border:3px solid white; color:black; background-color:blue; margin:9px; padding:3px; float:right; }
#questprog { border:1px solid white; color:white; background-color:#222266; padding:7px; border-radius:12px; position:relative; }
#questbar { background-color:blue; width:50%; border-radius:9px; padding-top:5px; padding-bottom:5px; }
#questnum { text-align:center; width:100%; position:absolute; top:11px; }

#img0 { height:155px; width:155px; margin:9px; border:1px solid black; border-radius:9px; float:left; }
#noms { float:left; margin-top:25px; }
.nomsen { font-size:1.2em; height:25px; color:white; cursor:pointer; }
.nomsen:hover { font-size:1.4em; color:yellow; }
#nomok { font-size:1.5em; color:#44FF44; }
#nomno { font-size:1.1em; color:#FF8888; }
#imgindic { height:62px; width:62px; border:3px solid red; border-radius:9px; }

#nom0 { font-size:1.4em; color:white; margin-top:25px; padding-bottom:25px; }
.imgsen { height:155px; width:155px; border:1px solid black; border-radius:9px; margin:3px; cursor:pointer; }
.imgsen:hover { transform:scale(1.1); border:3px solid yellow; margin:1px; } 
#imgok { height:170px; width:170px; border:5px solid #44FF44; border-radius:15px; }
#imgno { height:62px; width:62px; border:3px solid red; margin-left:9px; border-radius:9px; }
#nomindic { font-size:1.1em; color:#FF8888; }

#trombi { color:white; }
#tools { position:fixed; top:0; background-color:black; width:100%; padding:15px; }
#listsen { padding-top:45px; }
#nbsen { font-size:1.3em; color:white; border:2px solid white; border-radius:50%; margin-left:50px; padding:5px; background-color:#888888; }
.actif { cursor:pointer; height:32px; vertical-align:middle; }
.imgtrombi { height:62px; width:62px; border-radius:9px; float:left; }
.infotrombi { float:right; padding-left:5px;}
.senelt { color:white; text-decoration:none; border:1px solid grey; width:22%;
			padding:3px; margin:9px; box-shadow:3px 3px 5px white; display:inline-flex; }
.senelt:hover { background-color:#C80947; }
.senelt a { color:white; text-decoration:none; }
.sennom { font-weight:bold; margin-bottom:20px; }
.sendpt { color:yellow; }

.bouton { font-size:0.8em; background-color:#FFAA44; color:#882222; border-radius:20px; cursor:pointer; display:inline-block; }
.bouton:hover { color:white; }
.quit { position:absolute; bottom:15px; left:15px; }
.ok { background-color: lightgreen; margin:auto; width:90px; }
.reset { float:right; margin-right:99px; background-color:#8888FF; color:yellow; }

input[type="radio"] { margin-left:33px; color: white; }
legend, label { color: white; }


#error { font-size:1.1em; color:#C80947; border:1px solid; text-align:center; margin:0 auto; width:33%; background-color:#FFCCCC; }
#version a { font-size:0.8em; color:#777777; position:fixed; bottom:5px; right:9px; text-decoration:none; }

/* pour l'impression du trombi : */
@media print {
	body, #tools { background-color:white!important; }
	#back, .reset, #version { display:none; }
	#trombi { color:black; background-color:white; }
	.senelt, .sennom, .sendpt { color:black; }
	#nbsen { border:2px solid grey; }
}
</style>
<noscript>L'application nécessite l'activation de Javascript.</noscript>
<!--script type="text/javascript" src="datamask.js"></script--> <!--//tab_datamask[["m", s, x, y]]-->
<script type="text/javascript">
//
//no framework; it's funnier to reinvent the wheel.
//pas de framework; c'est plus drôle de réinventer la roue.
//
 const APPNAME = "Mes-Sen";
 const VERNUM = "1.047";
 const VERDES = "G. JANDOT - 27/02/2024";

 const TROMBI_OFF = -1;
 const TROMBI_NORMAL = 0;
 const TROMBI_ONLY = 1;
 var trombi_mode = TROMBI_NORMAL;

 const NB_PROP = 5;
 const MIN_NB_SEN = 200;
 const MAX_NB_SEN = 500;
 const DELAY_SHORT = 900; //ms
 const DELAY_LONG = 4000; //ms (=4s)
 var nb_max_quest = 20;
 var score_1 = 0;
 var score_2 = 0;
 //SCORE_3 = nb_max_quest
 const STR_SCORE_FIN = "SCORE FINAL = ";
 const NO_GROUP = "-Tous les groupes-";
 const NO_COMM = "-Toutes les commissions-";
 const NO_CIRC = "-Toutes les circonscriptions-";
 const NO_FILTER = "-filtre-"; //lowercase
 const NOFILT_COLOR = "#BBBBBB";
 const NBSP = "&nbsp;";
 const PX = "px";
 const UTF8_CHECK_MARK = "&#x2705";  // pict. right answer
 const UTF8_CROSS_MARK = "&#x274C";  // pict. wrong answer
 const BASE_SEN_URL = "https://www.senat.fr/";
 const DATA_URL = BASE_SEN_URL + "api-senat/senateurs.json";
 const CIVIL_HOMME = "M.";
 const SEXE_HOMME = "H";
 const SEXE_FEMME = "F";
 var DEF_M_SCALE = 1.0;
 var DEF_M_OFFX = 45;
 var DEF_M_OFFY = 100;
 const MASK_H_AJUST = 167;
 const MASK_V_AJUST = 115;
 
 var param_mask = "m";
 var conf_mask = 0;
 var param_timmax = "d";
 var conf_timmax = 9; //(s!)
 var param_nbquest = "q";
 var conf_nbquest = 20;

 var tab_senateurs = []; //objets "senateur"
	// .nom
	// .prenom
	// .mat
	// .nomrech
	// .id
	// .sexe
	// .groupe
	// .dpt
	// .comm
	// .imgok
	// .m_scale (mask scale)
	// .m_offx (mask x offset)
	// .m_offy (mask y offset)

 var tab_groupes = [];
 var tab_commissions = [];
 var tab_circonscriptions = [];
 
 //libelles de commission bien trop longs => codes à transposer
 const TABCOMM = new Map([
  ['COM-LOIS', 'Lois'],
  ['COM-FINC', 'Finances'],
  ['COM-ETRD', 'Aff. étrangères'],
  ['COM-SOCI', 'Aff. sociales'],
  ['COM-CDD', 'Aménagement terr. et dév. dur.'],
  ['COM-CAE', 'Aff. économiques'],
  ['COM-AFCL', 'Culture'],
]);

 //sorry for that; quelques codes de groupes politiques sont obsolètes
 const TABGRP = new Map([
  ['UMP', 'LR'],
  ['CRC', 'CRCE'],
  ['SOC', 'SER'],
  ['LREM', 'RDPI'],
  ['COM-CDD', 'Aménagement terr. et dév. dur.'],
  ['COM-CAE', 'Aff. économiques'],
  ['COM-AFCL', 'Culture'],
]);

 var tab_bonrep = []; //indices:0..4; valeurs : 1..5
 var tab_pastprop = [];

 var bonrep = 0;
 var score = 0;
 var scoremax = 0;
 var temps = 0;
 var hordeb = Date.now();
 var time_max = 9000; //ms (=9s)
 const TIME_REFRESH = 250; //ms
 var async_cpt = 0;
 var nb_imgerr = 0;
 var trombi_h = true;
 var trombi_f = true;
 var trombi_str = "";
 var trombi_corr = 0;
 var kb_ok = true; //keyboard answers enabled
 var cur_tip = "";
 var mask_on = false;
 var cur_game = 0;
 var tps_timeout;
 var cit_timeout;
 var numcit = -1;
 var cancit = false;
 const CIT_DELAY = 45000; //ms (=45s) 	- délai entre deux citations
 const CIT_DUR = 15000; //ms (=15s)		- durée affichage d'une citation
 
 const tab_citations = [
  ["\"Pour l'instant, c'est encore moi qui préside&nbsp;!\" - Christian PONCELET, 29/05/2008", "20080529#par_268"],
  ["\"Écoutez-moi bien, car cela vaut son pesant de saccharine&nbsp;!\" - Pierre-Yves COLLOMBAT, 24/03/2009", "20090324#par_2965"],
  ["\"Je crains aussi que l’immobilisme n’avance désormais en Europe et que rien ne puisse l’arrêter.\" - Jean BIZET, 11/04/2019", "20190411#par_1584"],
  ["\"C’est un peu parallèle, mais ce n’est pas convergent&nbsp;!\" - Bruno SIDO, 17/07/2014", "20140617#par_2341"],
  ["\"C’est une provocation que je continuerai à défendre – pardon, à dénoncer…\" - Stéphane RAVIER, 09/10/2019", "20191009#par_670"],
  ["\"Personnellement, je n’ai rien contre la chirurgie esthétique, mais pas aux frais du contribuable&nbsp;!\"-  Nathalie GOULET, 04/12/2020", "20201204#par_725"],
  ["\"Je vous rassure, je n’ai déposé aucun amendement visant à introduire la sexualité des bonobos dans la loi&nbsp;!\" - Pierre OUZOULIAS, 02/02/2010",
		"20210202#par_686"],
  ["\"Je vous remercie de me ramener au calme, monsieur le président.\" - Jean DESESSARD, 18/07/2008", "20080718#par_699"],
  ["\"En Auvergne, nous appelons le Téoz le «&nbsp;train Orangina&nbsp;», en référence au slogan&nbsp;: «&nbsp;Secouez-moi, secouez-moi&nbsp;!&nbsp;».\" - Alan NÉRI, 27/11/2013",
		"20131127#par_843"],
  ["\"Nous pouvons néanmoins nous asseoir sur la Constitution italienne […]\" - Jean-Baptiste LEMOYNE, 29 mai 2018", "20180529#par_417"],
  ["\"Voyage voyage, disait Desireless, célèbre chanteuse des années&nbsp;80.\" - Patrick KANNER, 4 octobre 2016", "20161004#par_2581"],
  ["\"C’est à la fin de la foire qu’on compte les bouses, comme vous le savez.\" - Jérôme DURAIN, 20 mars 2018", "20180320#par_901"],
  ["\"Au pays des sourds, les aveugles sont rois&nbsp;!\" - Yves DAUDIGNY, 26 octobre 2010", "20101026#par_463"],
  ["\"On ne saurait faire aboyer les chats&nbsp;!\" - René VANDIERENDONCK, 16 juillet 2015", "20150716#par_302"],
  ["\"Bien qu’étant membre de cette assemblée depuis seulement un an, je ne suis pas un pigeon de l’année…\" - Gérard ROCHE, 17 janvier 2013",
		"20130117#par_638"],
  ["\"Vous êtes comme les fraises d’hiver&nbsp;: vous êtes hors sol&nbsp;!\" - Pierre CHARON, 28 avril 2016", "20160428#par_1042" ],
  ["\"C’est un peu comme si l’on confiait au cow-boy Marlboro une enquête sur les méfaits du tabac.\" - Claude MALHURET, 30 mars 2021", "20210330#par_349"],
  ["\"Vu la dette que nous laisserons à nos enfants, nous ne devrons plus être surpris que les bébés crient à la naissance.\" - Claude MALHURET, 16 juillet 2020", "20200716#par_312"],
  ["\"Je voudrais simplement savoir si notre présence dans cet hémicycle, nos délibérations ne gênent pas trop les travaux des entreprises qui interviennent actuellement un peu partout dans le Sénat.\" - Michel CHARASSE, 19 juin 2008",
		"20080619#par_31"],
  ["\"Je propose que l’on ne décompte pas le temps d’orgasme de mon temps de parole&nbsp;!\" - Laurence ROSSIGNOL, 21 décembre 2018", "20181221#par_318"],
  ["\"Mais quelle est la grosseur de la poire, monsieur le ministre&nbsp;? Telle est la question&nbsp;!\" - Philippe MARINI, 8 décembre 2009", "20091208#par_470"],
  ["\"Contrairement au secteur de la restauration, la mort est un marché très stable.\" - Patricia SCHILLINGER, 18 décembre 2007", "20071218#par_628"],
  ["\"Cendrillon a compris que le prince n’avait absolument rien de charmant. De plus il est ruiné. Enfin, c’est un goujat, parce qu’il lui demande de porter le poids d’une partie de sa dette.\" - Raymonde LE TEXIER, 8 octobre 2010",
		"20101008#par_2586"],
  ["\"L’armagnac, le cognac et le calvados portent rarement le péché d’alcoolisme.\" - Aymeri de MONTESQUIOU, 9 novembre 2011", "20111109#par_1106"],
  ["\"Par fantaisie, Noël sera-t-il reporté à Pâques&nbsp;?\" - Jérôme BASCHER, 13 octobre 2020", "20201013#par_2449"],
  ["\"Pourquoi ne pas interdire de faire la vaisselle après dix-huit heures&nbsp;?\" - Michel BOUVARD, 14 décembre 2016", "20161214#par_470"],
  ["\"La girafe, on est en train de la peigner&nbsp;!\" - Michel BOUVARD, 14 décembre 2016", "20161214#par_481"],
  ["\"J'attends maintenant, ici et en direct, le porno du samedi soir... Cela finira par arriver&nbsp;! Je demande simplement qu'on ne tache pas mon fauteuil.\" - Michel CHARASSE, 15 mars 2005",
		"20050315#par_41"],
  ["\"On déshabille Paul pour habiller Pierre ou Jacques&nbsp;! À force d’être déshabillé, il va finir tout nu&nbsp;!\" - Cathy APOURCEAU-POLY, 30 novembre 2020", "20201130#par_1808"],
  ["\"On connaissait les victoires à la Pyrrhus&nbsp;; il y a maintenant les défaites gagnantes…\" - Claude MALHURET, 6 juillet 2022", "20220706#par_1065"],
  ["\"Monsieur ministre, la réponse est oui&nbsp;! Mais quelle était la question&nbsp;?\" - Marc-Philippe DAUBRESSE, 18 octobre 2022", "20221018#orat6"],
  ["\"J’ai dû subir à plusieurs reprises, sans d'ailleurs m’en émouvoir outre mesure, l’expression des besoins pressants de votre petit chien contre ma porte.\" - François FORTASSIN, 28 juin 2010", "20100628#par_3348"],
 ];

 //il faut être certain que les "guest stars" ne peuvent pas redevenir sénateurs
 //pour ne pas avoir à détecter d'éventuels doublons dans les propositions
 const tab_gueststars_H = [ 
	["François ABADIE","abadie_francois83008p",0.73,43,101],
	["Robert BADINTER","badinter_robert95006b",0.73,46,90],
	["Christian BONNET","bonnet_christian83016p",0.76,49,96],
	["Yvon BOURGES","bourges_yvon80011v",0.67,48,87],
	["Michel CHARASSE","charasse_michel81015e",0.85,44,94],
	["Raymond COURRIÈRE","courriere_raymond74050q",0.7,48,96],
	["Maurice COUVE DE MURVILLE","couve_de_murville_maurice59529v",0.88,44,130],
	["Serge DASSAULT","dassault_serge04055h",0.67,46,78],
	["Michel DELEBARRE","delebarre_michel11035h",1,51,105],
	["Edgar FAURE","faure_edgar000197",0.85,39,109],
	["Jean FRANÇOIS-PONCET","francois_poncet_jean83033q",0.7,45,81],
	["André LABARRÈRE","labarrere_andre01032m",0.67,50,101],
	["Raymond MARCELLIN","marcellin_raymond59715v",0.79,51,117],
	["Pierre MAUROY","mauroy_pierre92037v",0.7,47,86],
	["François MITTERAND","mitterrand_francois000379",0.94,56,124],
	["Gaston MONNERVILLE","monnerville_gaston000677",0.91,42,115],
	["René MONORY","monory_rene68036e",0.67,47,86],
	["Charles PASQUA","pasqua_charles77053g",0.67,46,70],
	["Jacques PELLETIER","pelletier_jacques66002k",0.64,51,93],
	["Alain PEYREFITTE","peyrefitte_alain95054k",0.73,35,101],
	["Alain POHER","poher_alain000211",0.85,44,116],
	["Christian PONCELET","poncelet_christian77058m",0.7,52,94],
	["Roger QUILLIOT","quilliot_roger74041p",0.94,65,122],
	["Jack RALITE","ralite_jack95060h",0.73,47,115],
	["Michel ROCARD","rocard_michel95064m",0.7,48,114],
	["Roger ROMANI","romani_roger59312e",0.88,47,98],
	["Maurice SCHUMANN","schumann_maurice74044s",0.88,36,102],
	["René TEULADE","teulade_rene08046y",0.79,45,91]
 ];

 const tab_gueststars_F = [
	["Magdeleine ANGLADE","anglade_magdeleine000465",0.91,52,128],
	["Nicole BRICQ","bricq_nicole04053f",0.88,52,92],
	["Paulette BRISEPIERRE","brisepierre_paulette89023p",0.61,48,88],
	["Dinah DERYCKE","derycke_dinah97007l",0.64,55,96],
	["Colette GIUDICELLI","giudicelli_colette08041t",0.73,55,87],
	["Nicole de HAUTECLOCQUE","de_hauteclocque_nicole000310",0.82,43,125],
	["Lucette MICHAUX-CHEVRY","michaux_chevry_lucette95050f",0.79,51,116],
	["Hélène MISSOFFE","missoffe_helene59552u",0.79,42,123],
	["Nelly OLIN","olin_nelly95051g",0.58,41,96],
	["Monique PAPON","papon_monique01054t",0.76,48,91],
	["Jeannette THOREZ VERMEERSCH","thorez_vermeersch_jeannette56829s",0.82,54,130]
 ];
 
 const PROBA_GUEST = 0.08; //tenir compte de l'éventuel écrasement par bonne réponse
 const G_OFFSET_H = 2000;
 const G_OFFSET_F = 5000;
 const ID_NONE = -1;
 const G_LABEL_H = "(ancien sénateur)";
 const G_LABEL_F = "(ancienne sénatrice)";
 const PROBA_PRENOMS = 0.05;

 
// refactoring / helpers
 function elt(nom_obj)  { return document.getElementById(nom_obj) }
 function show(nom_obj) { elt(nom_obj).style.display = "" }
 function hide(nom_obj) { elt(nom_obj).style.display = "none" }
 function flotte(e)     { elt(cur_tip).style.top = (e.clientY-50) + 'px' }
 function id2img(id)    { return BASE_SEN_URL + "senimg/" + id + "_carre.jpg" }
 function id2url(id)	{ return BASE_SEN_URL + "senateur/" + id + ".html" }
 function nomcomplet(i) { return tab_senateurs[i].prenom + " " + tab_senateurs[i].nom }
 function rnd(n)		{ return Math.floor(n*Math.random()) }
 function set_cur(nom)	{ document.body.style.cursor = nom }
 
 function multishow(nom, ideb, ifin)
 {
	for (var i=ideb; i<=ifin; i++)
	{
		show(nom+i);
	}
 }

 function multihide(nom, ideb, ifin)
 {
	for (var i=ideb; i<=ifin; i++)
	{
		hide(nom+i);
	}
 }
 
//////////////////////////
 
 function start()
 {
	//default : trombi_mode = TROMBI_NORMAL
	var param = window.location.search.toLowerCase();
	
	if (param== "?test")
	{
		test_citations();
		test_gueststars();
		return;
	}
	
 	if ( (param == "?trombi=0") || (param == "?notrombi"))
	{
		trombi_mode = TROMBI_OFF;
	}

 	if ( (param == "?trombi=1") || (param=="?trombi") )
	{
		trombi_mode = TROMBI_ONLY;
	}

	document.body.style.backgroundColor = "black";
	set_cur("wait");
	show("loading");
	elt("vernum").innerHTML = VERNUM;
	elt("version").title = VERDES;
	
	document.addEventListener('keyup', keyboard);
	load_config();
	ajax(DATA_URL, parsing);
 }
 
 function strnorm(str)
 //minuscules + retrait des accents
 {
	var r = str.toLowerCase();
	r = r.replace(new RegExp(/[àáâãäå]/g),"a");
	r = r.replace(new RegExp(/ç/g),"c");
	r = r.replace(new RegExp(/[èéêë]/g),"e");
	r = r.replace(new RegExp(/[ìíîï]/g),"i");
	r = r.replace(new RegExp(/ñ/g),"n");
	r = r.replace(new RegExp(/[òóôõö]/g),"o");
	r = r.replace(new RegExp(/[ùúûü]/g),"u");
	r = r.replace(new RegExp(/[ýÿ]/g),"y");
	return r;
 }
 
 function sen2id(nom)
 {
	var r = strnorm(nom);
	r = r.replace(new RegExp(/ /g),"_");
	r = r.replace(new RegExp(/-/g),"_");
	return r;
 }
 
 function is_sen(prenom, nom)
 {
	for (var i=0; i<tab_senateurs.length; i++)
	{
		if (tab_senateurs[i].nom==nom)
		{
			if (tab_senateurs[i].prenom==prenom)
			{
				return true;
			}
		}
	}	
	return false;
 }
 
 function find_sen(mat)
 {
	for (var i=0; i<tab_senateurs.length; i++)
	{
		if (tab_senateurs[i].mat==mat)
		{
			return i;
		}
	}
	return -1;
 }
 
 function fullurl(sdate)
 //transforme AAAAMMJJ#refname en
 //		https://www.senat.fr/seances/sAAAAMM/sAAAAMMJJ/sAAAAMMJJ_mono.html#refname
 {
	var res = BASE_SEN_URL + "seances";
	res = res + "/s" + sdate.substring(0,6);
	res = res + "/s" + sdate.substring(0,8);
	res = res + "/s" + sdate.substring(0,8) + "_mono.html" + sdate.substring(8);
	return res;
 }
 
// CITATIONS //////////////
 function rst_cittime()
 //called on every mouse move (body onmousemove)
 {
	if (!cancit) { return; }
	if (elt("citation").style.display=="none")
	//si une citation est affichée, on ne veut pas remettre le timer
	// (qui s'applique alors à la durée d'affichage) à zéro
	{
		clearTimeout(cit_timeout);
		cit_timeout = setTimeout(deb_cit, CIT_DELAY);
	} 
 }
 
 function deb_cit()
 {
	show("citation");
	cit_timeout = setTimeout(fin_cit, CIT_DUR);
 }
 
 function fin_cit()
 {
	hide("citation");
	new_cit();
	cit_timeout = setTimeout(deb_cit, CIT_DELAY);
 }
 
 function new_cit()
 {
	var newcit = rnd(tab_citations.length);
	while (newcit==numcit) //on veut éviter deux fois successivement la même citation
	{
		newcit = rnd(tab_citations.length);
	}
	numcit = newcit;
 	var citation = tab_citations[numcit];
	elt("citation").style.top= rnd(300) + PX;
 	elt("citation").innerHTML = "<A TARGET=\"_messen\" HREF=\"" + fullurl(citation[1]) + "\">" +	citation[0] + "</A>";
 }
 
 function test_citations()
 {
	show("messen");
	show("citation");
	for (var i=0; i<tab_citations.length; i++)
	{
		var citation = tab_citations[i];
		elt("citation").style.top= rnd(300) + PX;
		elt("citation").innerHTML = "<A TARGET=\"_messen\" HREF=\"" + fullurl(citation[1]) + "\">" +	citation[0] + "</A>";
		console.log(citation[0]); //!
		console.log(fullurl(citation[1])); //!
	}
 }
/////////////////////////
 
 function test_gueststars()
 {
	for (var i=0; i<tab_gueststars_H.length; i++)
	{
		console.log(tab_gueststars_H[i][0]); //!
		console.log(id2img(tab_gueststars_H[i][1])); //!
	}
	for (var i=0; i<tab_gueststars_F.length; i++)
	{
		console.log(tab_gueststars_F[i][0]); //!
		console.log(id2img(tab_gueststars_F[i][1])); //!
	}
 }
 
 function showtime()
 {
	elt("temps").style.backgroundColor = NOFILT_COLOR;
	temps = Date.now()-hordeb;
	var tps = Math.ceil((time_max-temps)/1000);
	elt("temps").innerHTML = tps;
	if (tps>0)
	{
		if (tps<6)
		{
			elt("temps").style.backgroundColor = "yellow";
		}
		if (tps<3)
		{
			elt("temps").style.backgroundColor = "orange";
		}
		tps_timeout = setTimeout(showtime, TIME_REFRESH);
	}
	else
	{
		elt("temps").style.backgroundColor = "red";
		if (cur_game==1) { verif1(0); }
		if (cur_game==2) { verif2(0); }
	}
 }
 

 
 function showmenu()
 {
	show("messen");
	cancit = true;
	new_cit();
	rst_cittime();
	
	if (nb_imgerr > (tab_senateurs.length/10))
	{
		elt("error").innerHTML = "Trop de photographies (" + nb_imgerr + ") sont manquantes.";
		show("error");
		hide("c1");
		hide("c2");
	} 
 }
 
 function ajax(url,callback)
 {
	var httpRequest = new XMLHttpRequest();
	if (!httpRequest) { return false; }
	httpRequest.onreadystatechange=function()
	{
		try
		{
			if (( httpRequest.readyState===XMLHttpRequest.DONE) && (httpRequest.status===200) )
			{
				callback(httpRequest.responseText);
			}
		} catch(e) { return false; }
	}
	httpRequest.open('GET',url);
	httpRequest.send();
	return true;
 }
 
 function tri_alphaSenateur(s1, s2)
 {
	if (s1.id>s2.id) return 1;
	if (s1.id<s2.id) return -1;
	return 0;
 }
 
 function parsing(texte)
 {
	var jsen = JSON.parse(texte);
	
	if ( (jsen.length < MIN_NB_SEN) || (jsen.length > MAX_NB_SEN) )
	{
		hide("loading");
		elt("error").innerHTML = "Nombre de sénateurs téléchargés (" + jsen.length + ") ";
		if (jsen.length < MIN_NB_SEN)
		{
			elt("error").innerHTML = elt("error").innerHTML + "insuffisant.";
		}
		else
		{
			elt("error").innerHTML = elt("error").innerHTML + "anormalement élevé.";
		}
		show("error");
	}
	else
	{
		for (var i=0; i<jsen.length; i++)
		{
			var senateur = new Object();
			senateur.nom = jsen[i]['nom'];
			senateur.prenom = jsen[i]['prenom'];
			senateur.normnom = strnorm(senateur.prenom + " " + senateur.nom); //pour filtrage sans accent
			senateur.sexe = jsen[i]['civilite'];
			if (senateur.sexe == CIVIL_HOMME)
			{
				senateur.sexe = SEXE_HOMME;
			}
			else
			{
				senateur.sexe = SEXE_FEMME;
			}
			//le "nom_technique" (tri) est malheureusement inexploitable en raison d'un grand nombre d'anomalies
			// (espaces et accents restants, matricule parfois présent et autres curiosités)
			//=>il faut le recalculer
			senateur.mat = jsen[i]['matricule'];
			senateur.id = senateur.nom + "_" + senateur.prenom + senateur.mat;
			senateur.id = sen2id(senateur.id);
			senateur.nom = senateur.nom.toUpperCase();
			
			//default mask
			/*senateur.m_scale = DEF_M_SCALE;
			senateur.m_offx = DEF_M_OFFX;
			senateur.m_offy = DEF_M_OFFY;*/
			
			try 
			{
				senateur.groupe = jsen[i]['groupe']['code'];
				if (TABGRP.get(senateur.groupe)!== undefined)
				{
					senateur.groupe = TABGRP.get(senateur.groupe);
				}
			}
			catch(e)
			//en début de mandat, le groupe n'est pas précisé immédiatement
			{
				senateur.groupe = "";
			}
			
			senateur.dpt = jsen[i]['circonscription']['code'] + " - " + jsen[i]['circonscription']['libelle'];
		
			var organismes = jsen[i]['organismes'];
			//le/la président.e du Sénat n'appartient à aucune commission permanente
			senateur.comm = "";
			for (var j=0; j<organismes.length; j++)
			{
				if (organismes[j]['type'] == "COMMISSION")
				{
					var lacomm = organismes[j]['code'];
					if (lacomm!="COMEUR-AFEU")
					//beurk; les AFFEUR ne devraient pas être catégorisées en commission permanente
					{
						if (TABCOMM.get(lacomm)!== undefined)
						{
							senateur.comm = TABCOMM.get(lacomm);
							break; //une seule commission permanente par sénateur
						}
					}
				}
			}
			
			senateur.imgok = true;
			tab_senateurs.push(senateur);
			//LISTE DES GROUPES - groups list
			if (tab_groupes.indexOf(senateur.groupe)==-1)
			{
				tab_groupes.push(senateur.groupe);
			}
			//LISTE DES COMMISSIONS - committees list
			if (senateur.comm!="") //président(e) du Sénat sans commission - no committee for the president
			{
				if (tab_commissions.indexOf(senateur.comm)==-1)
				{
					tab_commissions.push(senateur.comm);
				}
			}
			//LISTE DES CIRCONSCRIPTIONS - districts list
			if (tab_circonscriptions.indexOf(senateur.dpt)==-1)
			{
				tab_circonscriptions.push(senateur.dpt);
			}
		}
		
		tab_senateurs.sort(tri_alphaSenateur);
		tab_groupes.sort();
		tab_commissions.sort();
		tab_circonscriptions.sort();
		
		//parsing mask data
		/*for (var i=0; i<tab_datamask.length; i++)
		//tab_datamask[[["mat", scale, offset_x, offset_y]]
		{
			idx = find_sen(tab_datamask[i][0]); //matricule
			if (idx > -1)
			{
				senateur = tab_senateurs[idx];
				senateur.m_scale = tab_datamask[i][1]; //scale
				senateur.m_offx = tab_datamask[i][2]; //offset_x
				senateur.m_offy = tab_datamask[i][3]; //offset_y
			}
		}*/
		
		if (trombi_mode==TROMBI_OFF)
		{
			hide("loading");
			set_cur("default");
			hide("c3");
			showmenu();
		}
		else
		{
			async_cpt = 0;
			elt("loadinfo").innerHTML = "";
			elt("progress").max = tab_senateurs.length;
			show("progressbar");
			fill_trombi();
		}
	}
 }
 
 function imgerr(numsen)
 {
	nb_imgerr++;
	tab_senateurs[numsen].imgok = false;
 }
 
 function launch(numjeu)
 {
	clearTimeout(cit_timeout);
	hide("citation");
	cancit = false;
	hide("menu");
	if (numjeu<3)
	{
		show("quit");
		show("questprog");
		show("score");
	}
	cur_game = numjeu;
	switch (numjeu)
	{
		case 1:
			show("game1");
			game1(-1);
			break;
		case 2:
			show("game2");
			game2(-1);
			break;
		case 3:
			hide("messen");
			if (trombi_corr!=nb_imgerr)
			{
				corr_trombi();
			}
			show("trombi");
			document.title = APPNAME + " - Trombi";
			break;
		case 999:
			hide("score");
			load_config();//reload (pour refresh après un éventuel "escape" au clavier)
			show("config");
			document.title = APPNAME + " - Configuration";
			break;
	}
 }
 
 function change_masque(modif)
 {
	return;
	
	//si clic sur image => il faut changer l'état de la case à cocher
	if (modif)
	{
		elt("maskon").checked = !elt("maskon").checked;
	}
	
	if (elt("maskon").checked)
	{
		mask_on = true;
		elt("masque").className = "";
		elt("masque").title = "Masque activé";
	}
	else
	{
		mask_on = false;
		elt("masque").className = "niv_gris";
		elt("masque").title = "Masque désactivé";
	}
 }
 
 function quit() //exit trombi
 {
	cur_game = 0;
	clearTimeout(tps_timeout);
	document.title = APPNAME;
	hide("game1");
	hide("game2");
	hide("trombi");
	hide("questprog");
	hide("score");
	hide("temps");
	hide("quit");
	hide("config");
	show("messen");
	show("menu");
	cancit = true;
	rst_cittime();
 }
 
 function reset_trombi()
 {
	hide("reset");
	trombi_h = true;
	trombi_f = true;
	elt("selgrp").selectedIndex = 0;
	elt("selcom").selectedIndex = 0;
	elt("selcir").selectedIndex = 0;
	elt("filtre").value = NO_FILTER;
	elt("filtre").style.color = NOFILT_COLOR;
	majtrombi(0);
 }
 
 function starscore(score)
 {
	var res = "";
	var stars = 0;
	if (score>=score_1) 	 { stars++; }
	if (score>=score_2) 	 { stars++; }
	if (score>=nb_max_quest) { stars++; }
	for (var i=0; i<stars; i++)   { res += NBSP + "&#x2B50;"; } // utf8 start
	for (var i=0; i<3-stars; i++) {	res += NBSP + "&#x2606;"; } //utf8 empty star
	return res;
 }
 
 function keyboard()
 {
	switch (event.key) {
		case "1":
		case "2":
		case "3":
		case "4":
		case "5":
			var n = Number.parseInt(event.key);
			if (cur_game==0)
			{
				if (n<4)
				{
					launch(n);
					return;
				}
			}
			if (cur_game==1)
			{
				if (kb_ok)
				{
					kb_ok = false;
					verif1(n);
				}
			}
			if (cur_game==2)
			{
				if (kb_ok)
				{
					kb_ok = false;
					verif2(n);
				}
			}
			break;
		case "Enter":
		{
			if (cur_game==999)//config
			{
				valid_conf();
			}
		}
		case "Escape":
			if (cur_game>0)//loading
			{
				quit();
			}
			break;
		case "Backspace":
			if (cur_game==3) //trombi
			{
				if (document.activeElement!=elt("filtre"))
				{
					quit();
				}
			}
			else
			{
				if (cur_game>0)
				{
					quit();
				}
			}
			break;
		case "H":
		case "F":
		case "h":
		case "f":
			if (cur_game==3) //trombi
			{
				if (document.activeElement!=elt("filtre"))
				{
					if (event.key.toLowerCase()=="h")
					{
						majtrombi(1);
					}
					else
					{
						majtrombi(2);
					}
				}
			}
			break;
		case "0":
			if (cur_game==3) //trombi
			{
				if (document.activeElement!=elt("filtre"))
				{
					reset_trombi();
				}
			}
			break;
		/*case "m":
		case "M":
			if (cur_game==999)//config
			{
				change_masque(true); //mettre à jour la case à cocher
			}
			break;*/
		case "c":
		case "C":
			if (cur_game==0)//menu
			{
				launch(999);
			}
		default:
			return;
	}
 }
 
 function game1(val)
 {
	if (cur_game==0) //abandon
	{
		return;
	}
	hide("nomok");
	hide("imgindic");
	hide("nomno");
	hide("mask0");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tab_pastprop.length = 0;
	}
	document.title = APPNAME + " - PHOTO " + (scoremax+1) + "/" + nb_max_quest;
	elt("questnum").innerHTML = "PHOTO " + (scoremax+1) + "/" + nb_max_quest;
	elt("questbar").style.width = (100*(scoremax+1)/nb_max_quest) + "%";
	elt("score").innerHTML = "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=nb_max_quest)
	{		
		quit();
		show("score");
		document.title = APPNAME + " - " + STR_SCORE_FIN + score + "/" + scoremax; 
		elt("score").innerHTML = STR_SCORE_FIN + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
		
	var n = tab_senateurs.length;
	var nums = [];
	nums[0] = rnd(n);
	while (!tab_senateurs[nums[0]].imgok)
	{
		nums[0] = rnd(n);
	}
	var sexeref = tab_senateurs[nums[0]].sexe;
	
	nums[1] = rnd(n);
	var sexe = tab_senateurs[nums[1]].sexe;
	
	if (Math.random()<PROBA_PRENOMS)
	{
		//mode spécial "prénoms"
		//on cherche 4 autres prénoms
		while ( (nums[1]==nums[0]) || (sexe!=sexeref) ||
				(tab_senateurs[nums[1]].prenom==tab_senateurs[nums[0]].prenom) )
		{
			nums[1] = rnd(n);
			sexe = tab_senateurs[nums[1]].sexe;
		}
		nums[2] = rnd(n);
		sexe = tab_senateurs[nums[2]].sexe;
		while ( (nums[2]==nums[1]) || (nums[2]==nums[0]) || (sexe!=sexeref) || 
				(tab_senateurs[nums[2]].prenom==tab_senateurs[nums[1]].prenom) ||
				(tab_senateurs[nums[2]].prenom==tab_senateurs[nums[0]].prenom) )
		{
			nums[2] = rnd(n);
			sexe = tab_senateurs[nums[2]].sexe;
		}
		nums[3] = rnd(n);
		sexe = tab_senateurs[nums[3]].sexe;
		while ( (nums[3]==nums[2]) || (nums[3]==nums[1])|| (nums[3]==nums[0]) || (sexe!=sexeref) ||
				(tab_senateurs[nums[3]].prenom==tab_senateurs[nums[2]].prenom) ||
				(tab_senateurs[nums[3]].prenom==tab_senateurs[nums[1]].prenom) ||
				(tab_senateurs[nums[3]].prenom==tab_senateurs[nums[0]].prenom) )
		{
			nums[3] = rnd(n);
			sexe = tab_senateurs[nums[3]].sexe;
		}
		nums[4] = rnd(n);
		sexe = tab_senateurs[nums[4]].sexe;
		while ( (nums[4]==nums[3]) || (nums[4]==nums[2]) || (nums[4]==nums[1]) || (nums[4]==nums[0]) || (sexe!=sexeref) ||
				(tab_senateurs[nums[4]].prenom==tab_senateurs[nums[3]].prenom) ||
				(tab_senateurs[nums[4]].prenom==tab_senateurs[nums[2]].prenom) ||
				(tab_senateurs[nums[4]].prenom==tab_senateurs[nums[1]].prenom) ||
				(tab_senateurs[nums[4]].prenom==tab_senateurs[nums[0]].prenom) )
		{
			nums[4] = rnd(n);
			sexe = tab_senateurs[nums[4]].sexe;
		}
		elt("nom1").innerHTML = nomcomplet(nums[0]);
		for (var i=1; i<NB_PROP; i++) // bien 1, pas 0...
		{
			elt("nom"+(i+1)).innerHTML = tab_senateurs[nums[i]].prenom + " " + tab_senateurs[nums[0]].nom;
		}
		tab_bonrep[0] = nums[0];
		for (var i=1; i<NB_PROP; i++) // bien 1 (pas 0...)
		{
			tab_bonrep[i] = ID_NONE;
		}

		//vérif des noms générés (homonymie possible)
		for (var i=1; i<NB_PROP; i++)
		{
			if (is_sen(tab_senateurs[nums[i]].prenom, tab_senateurs[nums[0]].nom))
			{
				tab_bonrep[i] = nums[i];
			}		
		}

		elt("img0").src = id2img(tab_senateurs[nums[0]].id);
		/*if (mask_on)
		{
			elt("mask0").style.transform = `scale(${tab_senateurs[nums[0]].m_scale})`;
			elt("mask0").style.left = tab_senateurs[nums[0]].m_offx + PX;
			elt("mask0").style.top = (tab_senateurs[nums[0]].m_offy+45) + PX;
			show("mask0");
		}*/
		
		elt("nomok").innerHTML = nomcomplet(nums[0]);
		bonrep = rnd(NB_PROP)+1; //emplacement pour la bonne réponse
		if (bonrep>1)
		{
			var tmp_nom = elt("nom"+bonrep).innerHTML;
			elt("nom"+bonrep).innerHTML = nomcomplet(nums[0]);
			elt("nom1").innerHTML = tmp_nom;
			tab_bonrep[bonrep-1] = nums[0];
			tab_bonrep[0] = ID_NONE;
		}
	}
	else
	{	// mode normal
		while ( (nums[1]==nums[0]) || (sexe!=sexeref) || (!tab_senateurs[nums[1]].imgok) )
		{
			nums[1] = rnd(n);
			sexe = tab_senateurs[nums[1]].sexe;
		}
		nums[2] = rnd(n);
		sexe = tab_senateurs[nums[2]].sexe;
		while ( (nums[2]==nums[1]) || (nums[2]==nums[0]) || (sexe!=sexeref) || (!tab_senateurs[nums[2]].imgok) )
		{
			nums[2] = rnd(n);
			sexe = tab_senateurs[nums[2]].sexe;
		}
		nums[3] = rnd(n);
		sexe = tab_senateurs[nums[3]].sexe;
		while ( (nums[3]==nums[2]) || (nums[3]==nums[1])|| (nums[3]==nums[0]) || (sexe!=sexeref) || (!tab_senateurs[nums[3]].imgok) )
		{
			nums[3] = rnd(n);
			sexe = tab_senateurs[nums[3]].sexe;
		}
		nums[4] = rnd(n);
		sexe = tab_senateurs[nums[4]].sexe;
		while ( (nums[4]==nums[3]) || (nums[4]==nums[2]) || (nums[4]==nums[1]) || (nums[4]==nums[0]) || (sexe!=sexeref) || (!tab_senateurs[nums[4]].imgok) )
		{
			nums[4] = rnd(n);
			sexe = tab_senateurs[nums[4]].sexe;
		}
		//5 fausses réponses **différentes**
		for (var i=0; i<NB_PROP; i++)
		{
			elt("nom"+(i+1)).innerHTML = nomcomplet(nums[i]);
			tab_bonrep[i] = nums[i];
		}
	
		if (Math.random()<PROBA_GUEST)
		//rarement, on écrase une proposition de réponse par un invité ("guest star")
		//note : la bonne réponse peut l'écraser à son tour
		{
			var g = rnd(NB_PROP);
			if (sexeref==SEXE_HOMME)
			{
				var guestnum = rnd(tab_gueststars_H.length); 
				elt("nom"+(g+1)).innerHTML = tab_gueststars_H[guestnum][0];
				tab_bonrep[g] = G_OFFSET_H + guestnum;
			}
			else //SEXE_FEMME
			{
				var guestnum = rnd(tab_gueststars_F.length); 
				elt("nom"+(g+1)).innerHTML = tab_gueststars_F[guestnum][0];
				tab_bonrep[g] = G_OFFSET_F + guestnum;		
			}
		}
	
		//écrasement avec la bonne réponse à un endroit (bonrep [1..5])) au hasard
		var vnum = 0;
		var prop_ok = true;
		do
		{
			vnum = rnd(n);
			sexe = tab_senateurs[vnum].sexe;
			while ( (vnum==nums[4]) || (vnum==nums[3]) || (vnum==nums[2]) || (vnum==nums[1]) || (vnum==nums[0]) || (sexe!=sexeref) || (!tab_senateurs[vnum].imgok) )
			{
				vnum = rnd(n);
				sexe = tab_senateurs[vnum].sexe;
			}
			prop_ok = true;
			for (var i=0; i<tab_pastprop.length; i++)
			{
				if (vnum==tab_pastprop[i])
				{
					prop_ok = false;
				}
			}
		} while (!prop_ok);
		tab_pastprop.push(vnum);

		bonrep = rnd(NB_PROP)+1;
		elt("img0").src = id2img(tab_senateurs[vnum].id);
		/*if (mask_on)
		{
			elt("mask0").style.transform = `scale(${tab_senateurs[vnum].m_scale})`;
			elt("mask0").style.left = tab_senateurs[vnum].m_offx + PX;
			elt("mask0").style.top = (tab_senateurs[vnum].m_offy+45) + PX;
			show("mask0");
		}*/
		elt("nom"+bonrep).innerHTML = nomcomplet(vnum);
		elt("nomok").innerHTML = nomcomplet(vnum);
	} // mode normal

	multishow("nom", 1, NB_PROP);
	show("temps");
	hordeb = Date.now();
	showtime();
	kb_ok= true;
 }
 
 function verif1(rep)
 {
	clearTimeout(tps_timeout);
	multihide("nom", 1, NB_PROP);
	hide("mask0");
	var delay = DELAY_SHORT;
	if ((rep!==bonrep) && (rep>0)) //rep==0 : time's out
	{
		delay = DELAY_LONG;
		elt("nomno").innerHTML = UTF8_CROSS_MARK + NBSP + elt("nom"+rep).innerHTML;
		var numsen = tab_bonrep[rep-1];
		if (numsen==ID_NONE) //mode prénom, mauvais prénom
		{
			show("nomno");
			//pas d'image
		}
		else
		{
			if (numsen < G_OFFSET_H) //et < G_OFFSET_F : cas général
			{
				elt("imgindic").src = id2img(tab_senateurs[numsen].id);
			}
			else
			{
				if (numsen >= G_OFFSET_F) //"guest star" femme
				{
					elt("imgindic").src = id2img(tab_gueststars_F[numsen-G_OFFSET_F][1]);
					elt("nomno").innerHTML = elt("nomno").innerHTML + " " + G_LABEL_F;
				}
				else //G_OFFSET_H <= numsen <G_OFFSET_F : "guest star" homme
				{
					elt("imgindic").src = id2img(tab_gueststars_H[numsen-G_OFFSET_H][1]);
					elt("nomno").innerHTML = elt("nomno").innerHTML + " " + G_LABEL_H;
				}
			}
			show("nomno");
			show("imgindic");
		}
	}
	else
	{	
		if (rep==0)
		{
			delay = DELAY_LONG;
			elt("nomok").innerHTML = NBSP + elt("nomok").innerHTML;
		}
		else
		{
			elt("nomok").innerHTML = UTF8_CHECK_MARK + NBSP + elt("nomok").innerHTML;
		}	
	}
	show("nomok");
	setTimeout(function(){ game1(rep); }, delay);
 }

 function game2(val)
 {
	if (cur_game==0) //abandon
	{
		return;
	}
 	hide("imgok");
	hide("nomindic");
	hide("imgno");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tab_pastprop.length = 0;
	}
	document.title = APPNAME + " - NOM " + (scoremax+1) + "/" + nb_max_quest;
	elt("questnum").innerHTML = "NOM " + (scoremax+1) + "/" + nb_max_quest;
	elt("questbar").style.width = (100*(scoremax+1)/nb_max_quest) + "%";
	elt("score").innerHTML = "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=nb_max_quest)
	{		
		quit();
		show("score");
		document.title = APPNAME + " - " + STR_SCORE_FIN + score + "/" + scoremax;
		elt("score").innerHTML = STR_SCORE_FIN + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
	
	var n = tab_senateurs.length;
	var nums = [];
	var sexeref = "";
	for (var i=0; i<NB_PROP; i++)
	{
		var ok = false;
		while (!ok)
		{
			nums[i] = rnd(n);
			sexe = tab_senateurs[nums[i]].sexe;
			ok = tab_senateurs[nums[0]].imgok; //pas de sénateur sans photo
			if (i>0)
			{
				ok &= (sexe==sexeref);
				for (var j=0; j<i; j++)
				{
					ok &= (nums[j]!=nums[i]);
				}
			}
			else
			{
				sexeref = sexe;
			}
		}
	}	
	
	
	//5 fausses réponses **différentes**
	for (var i=0; i<NB_PROP; i++)
	{
		elt("img"+(i+1)).src = id2img(tab_senateurs[nums[i]].id);
	}

	/*if (mask_on)
	{
		for (var i=0; i<NB_PROP; i++)
		{
			var eltname = "mask"+(i+1);
			elt(eltname).style.transform = `scale(${tab_senateurs[nums[i]].m_scale})`;
			elt(eltname).style.left = (tab_senateurs[nums[i]].m_offx + i*MASK_H_AJUST - 3) + PX;
			elt(eltname).style.top = (tab_senateurs[nums[i]].m_offy + MASK_V_AJUST) + PX;
			elt(eltname).style.pointerEvents = "none";
		}
		multishow("mask", 1, NB_PROP);
	}
	else
	{
		multihide("mask", 1, NB_PROP);
	}*/

	for (var i=0; i<NB_PROP; i++)
	{
		tab_bonrep[i] = nums[i];
	}
		
	if (Math.random()<PROBA_GUEST)
	//rarement, on écrase une proposition de réponse par un invité ("guest star")
	//note : la bonne réponse peut l'écraser à son tour
	{
		var g = rnd(NB_PROP);
		if (sexeref==SEXE_HOMME)
		{
			var guestnum = rnd(tab_gueststars_H.length); 
			elt("img"+(g+1)).src = id2img(tab_gueststars_H[guestnum][1]);
			elt("mask"+(g+1)).style.transform = `scale(${tab_gueststars_H[guestnum][2]})`;
			elt("mask"+(g+1)).style.left = (tab_gueststars_H[guestnum][3] + (g)*MASK_H_AJUST - 3) + PX;
			elt("mask"+(g+1)).style.top = (tab_gueststars_H[guestnum][4] + MASK_V_AJUST) + PX;			
			tab_bonrep[g] = G_OFFSET_H + guestnum;
		}
		else //SEXE_FEMME
		{
			var guestnum = rnd(tab_gueststars_F.length); 
			elt("img"+(g+1)).src = id2img(tab_gueststars_F[guestnum][1]);
			elt("mask"+(g+1)).style.transform = `scale(${tab_gueststars_F[guestnum][2]})`;
			elt("mask"+(g+1)).style.left = (tab_gueststars_F[guestnum][3] + (g)*MASK_H_AJUST - 3) + PX;
			elt("mask"+(g+1)).style.top = (tab_gueststars_F[guestnum][4] + MASK_V_AJUST) + PX;			
			tab_bonrep[g] = G_OFFSET_F + guestnum;		
		}
	}
	
	//écrasement avec la bonne réponse à un endroit ("bonrep" [1..5]) au hasard
	var vnum = 0;
	var prop_ok = true;
	do
	{		
		var ok = true;
		do
		{
			vnum = rnd(n);
			sexe = tab_senateurs[vnum].sexe;
			ok = tab_senateurs[vnum].imgok;
			ok &= (sexe==sexeref);
				for (var i=0; i<NB_PROP; i++)
				{
					ok &= (vnum!=nums[i]);
				}		
		} while (!ok)
		
		prop_ok = true;
		for (var i=0; i<tab_pastprop.length; i++)
		{
			if (vnum==tab_pastprop[i])
			{
				prop_ok = false;
			}
		}
	} while (!prop_ok);
	tab_pastprop.push(vnum);
	
	bonrep = rnd(NB_PROP)+1;
	elt("nom0").innerHTML= nomcomplet(vnum);
	var varimg = "img" + bonrep;
	elt(varimg).src = id2img(tab_senateurs[vnum].id);
	/*if (mask_on)
	{
		var varmask = "mask" + bonrep;
		elt(varmask).style.transform = `scale(${tab_senateurs[vnum].m_scale})`;
		elt(varmask).style.left = (tab_senateurs[vnum].m_offx + (bonrep-1)*MASK_H_AJUST - 3) + PX;
		elt(varmask).style.top = (tab_senateurs[vnum].m_offy + MASK_V_AJUST) + PX;
	}*/
	elt("imgok").src = elt(varimg).src;
	multishow("img", 1, NB_PROP);
	show("temps");
	hordeb = Date.now();
	showtime();
	kb_ok = true;
 }
 
 function verif2(rep)
 {
	clearTimeout(tps_timeout);
	multihide("img", 1, NB_PROP);
	multihide("mask", 1, NB_PROP);
	show("imgok");
	var delay = DELAY_SHORT;
	if ( (rep!==bonrep) && (rep>0) ) //rep==0 : time's out
	{
		delay = DELAY_LONG;
		elt("imgno").src = elt("img"+rep).src;
		show("imgno");
		var numsen = tab_bonrep[rep-1];
		if (numsen < G_OFFSET_H) //et < G_OFFSET_F : cas général
		{
			elt("nomindic").innerHTML = nomcomplet(numsen);
		}
		else
		{
			if (numsen >= G_OFFSET_F) //"guest star" femme
			{
				elt("nomindic").innerHTML = tab_gueststars_F[numsen-G_OFFSET_F][0] + " " + G_LABEL_F;
			}
			else //G_OFFSET_H <= numsen <G_OFFSET_F : "guest star" homme
			{
				elt("nomindic").innerHTML = tab_gueststars_H[numsen-G_OFFSET_H][0] + " " + G_LABEL_H;
			}
		}
		show("nomindic");
	}
	if (rep==0)
	{
		delay = DELAY_LONG;
	}
	setTimeout(function(){ game2(rep); }, delay);
 }

// TROMBI /////////////////
 function fill_trombi()
 {
	var i = async_cpt;
	
	trombi_str += "<A HREF=\"" + id2url(tab_senateurs[i].id) + "\" TARGET=\"_messen\"><div class=\"senelt\" id=\"" + tab_senateurs[i].id + "\">"
			+ "<img class=\"imgtrombi\" src=\"" + id2img(tab_senateurs[i].id) + "\" onerror=\"imgerr(" + i +")\">"
			+ "<div class=\"infotrombi\"><div class=\"sennom\">" + nomcomplet(i) + "</div>"
			+ "<div class=\"sengrp\">" + tab_senateurs[i].groupe + "</div>"
			+ "<div class=\"sencom\">" + tab_senateurs[i].comm + "</div>"
			+ "<div class=\"sendpt\">" + tab_senateurs[i].dpt + "</div></div></div></A>";
	
	async_cpt++;
	elt("progress").value = async_cpt;
	elt("loadinfo").innerHTML = "Préparation du trombi (" + async_cpt + "/" + tab_senateurs.length + ")";
	
	if (async_cpt<tab_senateurs.length)
	{
		setTimeout(fill_trombi, 0); //async, to allow UI updates (animated gif + progressbar)
	}
	else
	{
		hide("loading");
		elt("listsen").innerHTML = trombi_str;
		trombi_str = "";
		var grp = elt("selgrp");
		grp.innerHTML = "<option value=\"\">" + NO_GROUP + "</option>";
		for (var i=0; i< tab_groupes.length; i++)
		{
			grp.innerHTML += "<option value=\"" + tab_groupes[i] + "\">" + tab_groupes[i] + "</option>";
		}
		var com = elt("selcom");
		com.innerHTML = "<option value=\"\">" + NO_COMM + "</option>";
		for (var i=0; i< tab_commissions.length; i++)
		{
			com.innerHTML += "<option value=\"" + tab_commissions[i] + "\">" + tab_commissions[i] + "</option>";
		}
		var circo = elt("selcir");
		circo.innerHTML = "<option value=\"\">" + NO_CIRC + "</option>";
		for (var i=0; i< tab_circonscriptions.length; i++)
		{
			circo.innerHTML += "<option value=\"" + tab_circonscriptions[i] + "\">" + tab_circonscriptions[i] + "</option>";
		}
		reset_trombi(); //init trombi
		if (trombi_mode==TROMBI_ONLY)
		{
			hide("back");
			launch(3);
		}
		else
		{
			showmenu();
		}
		set_cur("default");
	}
 }
 
 function corr_trombi()
 //remplacement des images non trouvées par une image générique
 {
	var str = elt("listsen").innerHTML;
	for (var i=0; i<tab_senateurs.length; i++)
	{
		if (!tab_senateurs[i].imgok)
		{
			position = str.indexOf(id2img(tab_senateurs[i].id));
			if (position>-1) //le remplacement n'a pas déjà été fait
			{
				longueur = id2img(tab_senateurs[i].id).length;
				str = str.substring(0,position) + "nopict.jpg" + str.substring(position+longueur);
				trombi_corr++;
			}
		}
	}
	elt("listsen").innerHTML = str;
 }
 
 function initfilter()
 {
	if (elt("filtre").value == NO_FILTER)
	{
		elt("filtre").value = "";
		elt("filtre").style.color = "black";
	}
 }
 
 function veriffilter()
 {
	if (elt("filtre").value.trim().length==0)
	{
		elt("filtre").value = NO_FILTER;
		elt("filtre").style.color = NOFILT_COLOR;
	}
 }

 function majtrombi(action)
 {
	var filtre = strnorm(elt("filtre").value.trim());
	var filgrp = elt("selgrp").options[elt("selgrp").selectedIndex].text;
	var filcom = elt("selcom").options[elt("selcom").selectedIndex].text;
	var filcir = elt("selcir").options[elt("selcir").selectedIndex].text;
	if (action==1) //hommes
	{
		trombi_h = !trombi_h;
	}
	if (action==2) //femmes
	{
		trombi_f = !trombi_f;
	}
	if (trombi_h && trombi_f)
	{
		hide("reset");
	}
	else
	{
		show("reset");
	}
		
	if (trombi_h)
	{
		elt("hommes").src = "genre_h.png";
	}
	else
	{
		elt("hommes").src = "genre_noh.png";
	}
	if (trombi_f)
	{
		elt("femmes").src = "genre_f.png";
	}
	else
	{
		elt("femmes").src = "genre_nof.png";
	}
	if ( ((filtre!= NO_FILTER) && (filtre!=""))
			|| (filgrp != NO_GROUP)
			|| (filcom != NO_COMM)
			|| (filcir != NO_CIRC)
		)
	{
		show("reset");
	}

	for (var i=0; i<tab_senateurs.length; i++)
	{
		if (tab_senateurs[i].sexe == SEXE_HOMME)
		{
			if (trombi_h)
			{
				show(tab_senateurs[i].id);
			}
			else
			{
				hide(tab_senateurs[i].id);
			}				
		}
		else //SEXE_FEMME
		{
			if (trombi_f)
			{
				show(tab_senateurs[i].id);
			}
			else
			{
				hide(tab_senateurs[i].id);
			}
		}
		
		if ( (filtre!=NO_FILTER) && (filtre!="") )
		{
			//if (!(tab_senateurs[i].normnom.includes(filtre))) //IE doesn't know "String.prototype.includes()"
			if (tab_senateurs[i].normnom.indexOf(filtre)==-1)
			{
				hide(tab_senateurs[i].id);
			}
		}
		if (filgrp != NO_GROUP)
		{
			if (tab_senateurs[i].groupe != filgrp)
			{
				hide(tab_senateurs[i].id);
			}
		}
		if (filcom != NO_COMM)
		{
			if (tab_senateurs[i].comm != filcom)
			{
				hide(tab_senateurs[i].id);
			}
		}
		if (filcir != NO_CIRC)
		{
			if (tab_senateurs[i].dpt != filcir)
			{
				hide(tab_senateurs[i].id);
			}
		}		
	}

	var cptsen = 0;
	for (var i=0; i<tab_senateurs.length; i++)
	{
		if (elt(tab_senateurs[i].id).style.display == "")
		{
			cptsen++;
		}
	}
	elt("nbsen").innerHTML = cptsen;
	if (cptsen==0)
	{
		show("vide");
	}
	else
	{
		hide("vide");
	}
 }
 
 function save_config()
 {
	conf_mask = 0;
	if (mask_on)
	{
		conf_mask = 1;
	}
	localStorage.setItem(param_mask, conf_mask);
	conf_timmax = time_max/1000;
	localStorage.setItem(param_timmax, conf_timmax);
	conf_nbquest = nb_max_quest;
	localStorage.setItem(param_nbquest, conf_nbquest);
 }
 
  function getint_localstorage(varname, defvalue)
 {
	var tempvar = localStorage.getItem(varname);
	if (tempvar==null)
	{
		return defvalue;
	}
	else
	{
		tempvar = parseInt(localStorage.getItem(varname), 10);
		return tempvar;
	}
 }
 
 function load_config()
 {
	mask_on = false;
	/*conf_mask = getint_localstorage(param_mask, 0);
	if (conf_mask==1)
	{
		mask_on = true;
	}*/
	conf_timmax = getint_localstorage(param_timmax, 9);
	time_max = conf_timmax*1000;
	conf_nbquest = getint_localstorage(param_nbquest, 20);
	nb_max_quest = conf_nbquest;
	score_1 = 0.75 * nb_max_quest;  //(15/20)
    score_2 = 0.9 * nb_max_quest;
	
	//update config. screen
	/*elt("maskon").checked = mask_on;
	change_masque(false);*/

	switch(nb_max_quest)
	{
		case 5:
				elt("nbq1").checked = true;
				break;
		case 10:
				elt("nbq2").checked = true;
				break;
		case 15:
				elt("nbq3").checked = true;
				break;
		case 20:
				elt("nbq4").checked = true;
				break;
		case 25:
				elt("nbq5").checked = true;
				break;
		default : 
				elt("nbq4").checked = true;
				break;
	}
	switch(conf_timmax)
	{
		case 5:
				elt("dr1").checked = true;
				break;
		case 9:
				elt("dr2").checked = true;
				break;
		case 10:
				elt("dr3").checked = true;
				break;
		case 20:
				elt("dr4").checked = true;
				break;
		case 30:
				elt("dr5").checked = true;
				break;
		default : 
				elt("dr4").checked = true;
				break;
	}
 }
 
 function change_val(code, valeur)
 {
	if (code=="n")
	{
		nb_max_quest = valeur;
		score_1 = 0.75 * nb_max_quest;
		score_2 = 0.9 * nb_max_quest; 
	}
	if (code=="t")
	{
		time_max = valeur*1000;
	}
 }
 
 function valid_conf()
 {
	save_config();
	quit();
 }
 
</script>
</head>
<body onload="start()" onmousemove="rst_cittime()" style="user-select:none">
<div id="loading" style="display:none">
	<p align="center"><img src="senanim.gif" style="vertical-align:middle" width="50" height="52" ALT="Logo">
	<span id="loadinfo">Téléchargement des données...</span></p>
	<div id="progressbar" style="display:none"><progress id="progress" value="0" max="100"></progress></div>
</div> <!--/loading-->

<div id="error" style="display:none"></div>

<div id="messen" style="display:none">

	<div id="questprog" style="display:none"><div id="questbar">&nbsp;</div><span id="questnum"></span></div>
	<div id="score" style="display:none"></div>
	<div id="temps" style="display:none"></div>

	<div id="menu">
		<div id="c1" onclick="launch(1)" class="gamesel"
				onmouseenter="cur_tip='tip1'; show('tip1')" onmouseleave="hide('tip1')" onmousemove="flotte(event)"
				>"Quel nom&nbsp;?"</div>
		<div id="tip1" style="display:none" class="tooltip">Pour 1 photo, plusieurs noms.<BR>Il faut trouver le bon.
			<span class="clavier"><BR>[1]</span></div>
		<div id="c2" onclick="launch(2)" class="gamesel"
				onmouseenter="cur_tip='tip2'; show('tip2')" onmouseleave="hide('tip2')" onmousemove="
				(event)"
				>"Quelle photo&nbsp;?"</div>
		<div id="tip2" style="display:none" class="tooltip">Pour 1 nom, plusieurs photos.<BR>Il faut trouver la bonne.
			<span class="clavier"><BR>[2]</span></div>
		<div id="c3" onclick="launch(3)" class="gamesel"
					onmouseenter="cur_tip='tip3'; show('tip3')" onmouseleave="hide('tip3')" onmousemove="flotte(event)"
				>Trombi</div>
		<div id="tip3" style="display:none" class="tooltip">Trombinoscope<BR>interactif
			<span class="clavier"><BR>[3]</span></div>
			
		<div id="ico_conf">
			<img src="ico_conf.png" alt="configuration" title="Configuration [c]"
				 onclick="launch(999)">
		</div> <!--ico_conf-->
		
	</div> <!--/menu-->

	<div id="citation" style="display:none"></div>

	<div id="game1" style="display:none">
		<img id="img0" title="Il faut cliquer sur le nom qui correspond à cette photo. (clavier : touches [1] à [5])">
		<img id="mask0" src="masque.png" style="display:none;position:absolute;top:100px;left:45px">
		<div id="noms">
			<div id="nom1" class="nomsen" onclick="verif1(1)"></div>
			<div id="nom2" class="nomsen" onclick="verif1(2)"></div>
			<div id="nom3" class="nomsen" onclick="verif1(3)"></div>
			<div id="nom4" class="nomsen" onclick="verif1(4)"></div>
			<div id="nom5" class="nomsen" onclick="verif1(5)"></div>
			<div id="nomok"></div>
			<div id="nomno"></div><img id="imgindic">
		</div> <!--/noms-->
	</div> <!--/game1-->

	<div id="game2" style="display:none">
		<div id="nom0" title="Il faut cliquer sur la photo qui correspond à ce nom. (clavier : touches [1] à [5])"></div>
		<img id="img1" class="imgsen" onclick="verif2(1)"><img id="mask1" src="masque.png" style="display:none;position:absolute;top:150px;left:45px">
		<img id="img2" class="imgsen" onclick="verif2(2)"><img id="mask2" src="masque.png" style="display:none;position:absolute;top:150px;left:212px">
		<img id="img3" class="imgsen" onclick="verif2(3)"><img id="mask3" src="masque.png" style="display:none;position:absolute;top:150px;left:379px">
		<img id="img4" class="imgsen" onclick="verif2(4)"><img id="mask4" src="masque.png" style="display:none;position:absolute;top:150px;left:546px">
		<img id="img5" class="imgsen" onclick="verif2(5)"><img id="mask5" src="masque.png" style="display:none;position:absolute;top:150px;left:713px">
		<img id="imgok">
		<img id="imgno">&nbsp;<span id="nomindic"></span>
	</div> <!--/game2-->
	
	<div id="config" style="display:none">
		<fieldset>
			<legend>Nombre de questions par partie :</legend>
			<input type="radio" id="nbq1" name="nbquest" value="5" onclick="change_val('n',5)">
				<label for="nbq1">5</label>
			<input type="radio" id="nbq2" name="nbquest" value="10" onclick="change_val('n',10)">
				<label for="nbq2">10</label>
			<input type="radio" id="nbq3" name="nbquest" value="15" onclick="change_val('n',15)">
				<label for="nbq3">15</label>
			<input type="radio" id="nbq4" name="nbquest" value="20" onclick="change_val('n',20)">
				<label for="nbq4">20</label>
			<input type="radio" id="nbq5" name="nbquest" value="25" onclick="change_val('n',25)">
				<label for="nbq5">25</label>
		</fieldset>
		<fieldset>
			<legend>Délai de réponse imparti (en secondes) :</legend>
			<input type="radio" id="dr1" name="delairep" value="5" onclick="change_val('t',5)">
			<label for="dr1">5</label>
			<input type="radio" id="dr2" name="delairep" value="9" onclick="change_val('t',9)">
			<label for="dr2">9</label>
			<input type="radio" id="dr3" name="delairep" value="10" onclick="change_val('t',10)">
			<label for="dr3">10</label>
			<input type="radio" id="dr4" name="delairep" value="20" onclick="change_val('t',20)">
			<label for="dr4">20</label>
			<input type="radio" id="dr5" name="delairep" value="30" onclick="change_val('t',30)">
			<label for="dr5">30</label>
		</fieldset>
		<UL>
		<!--div id="chx_masque"><input id="maskon" type="checkbox" onchange="change_masque(false)" title="Activer/Désactiver le masque (clavier : touche [M])">
			<img id="masque" width="75px" src="masque.png" alt="masque" title="Masque désactivé"
				class="niv_gris" onclick="change_masque(true)">
		</div--> <!--chx_masque-->
		<button id="btnok" onclick="valid_conf()" class="bouton quit ok">OK</button>
	</div> <!--/config-->

	<button id="quit" style="display:none" onclick="quit()" class="bouton quit">Abandonner</button>
</div> <!--/messen-->

<div id="trombi" style="display:none">
	<div id="tools">
		<img id="hommes" onclick="majtrombi(1)" src="genre_h.png" class="actif" alt="Hommes" title="Hommes">&nbsp;
		<img id="femmes" onclick="majtrombi(2)" src="genre_f.png" class="actif" alt="Femmes" title="Femmes">&nbsp;
		<select id="selgrp" onchange="majtrombi(0)" title="Sélection d'un groupe politique"></select>
		<select id="selcom" onchange="majtrombi(0)" Title="Sélection d'une commission permanente"></select>
		<select id="selcir" onchange="majtrombi(0)" Title="Sélection d'une circonscription"></select>
		<input id="filtre" type="text" oninput="majtrombi(0)" onfocus="initfilter()" onfocusout="veriffilter()"
				title="Filtre textuel sur les noms et prénoms">
		<button id="back" onclick="quit()" class="bouton" title="Revenir au menu">Retour</button>
		<id id="nbsen" title="Compteur de résultats"></id>
		<button id="reset" onclick="reset_trombi()" style="display:none" class="bouton reset"
			title="Effacer tous les filtres de recherche (clavier: touche [0])">Réinitialiser</button>
	</div> <!--tools-->
	<div id="listsen"></div>
	<div id="vide" class="senelt" style="display:none" title="(personne)">Aucun résultat.</div>
</div> <!--/trombi-->

<div id="version"><A HREF="https://github.com/gjandot/mes_sen/" TARGET="_messen">Version <span id="vernum">0.000</span></A></div>
</body>
</html>
