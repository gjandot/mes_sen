<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--IDs
* utiliser données du Sénat
* normalisation des noms : pb noms composés avec trait d'union (Paoli-Gagin)
* numéro de photo (jeux) sous forme d'une barre de progression
* largeur zone noms
* trombi : filtre par commmission + affichage commission
* mode "défi" : tous les sénateurs. Arrêt à la première erreur.
* plusieurs difficultés (nombres de propositions)
* photos non sénateurs (secret guest stars)
* noms inventés
* prénoms changés
* délai de réponse max
* recherche de combinaisons spéciales (prénoms identiques...) ?
* utilisation des images du trombi ?
* problématique des images absentes (début de mandat)
*/
-->
<title>Mes-Sen</title>
<style>
#messen { height:500px; width:850px; margin:auto; padding:9px; border-radius:20px; background-color:#C80947; }
#loading { font-size:1.2em; color: white; }
.gamesel { position:relative; height:120px; width:250px; color:white; font-size:1.5em; cursor:pointer; background-color:blue;
			border:3px solid black; margin:10px; border-radius:25px; text-align:center; line-height:120px; }
.gamesel:hover { border:3px solid yellow; background-color:white; color:blue; font-size:2em; }
#score { border:1px solid white; color:lightblue; background-color:blue; margin:9px; padding:3px; }

#img0 { height:225px; width:155px; margin:9px; border:1px solid black; border-radius:9px; }
.nomsen { font-size:1.2em; color:white; cursor:pointer; }
.nomsen:hover { font-size:1.4em; color:yellow; }
#nomok { font-size:1.5em; color:#44FF44; }
#nomno { font-size:1.1em; color:#FF8888; }
#imgindic { height:90px; width:62px; border:3px solid red; border-radius:9px; }

#nom0 { font-size:1.4em; color:white; margin-top:25px; padding-bottom:25px; cursor:pointer; }
.imgsen { height:225px; width:155px; border:1px solid black; border-radius:9px; margin:3px; cursor:pointer; }
.imgsen:hover { transform:scale(1.1); border:3px solid yellow; margin:1px; } 
#imgok { height:247px; width:170px; border:5px solid green; border-radius:15px; }
#imgno { height:90px; width:62px; border:3px solid red; margin-left:9px; border-radius:9px; }
#nomindic { font-size:1.1em; color:#FF8888; }

#trombi { color:white; }
.chactif { color:lightgreen; text-decoration:none; cursor:pointer; border:1px solid lightgreen; }
.chinactif { color:red; text-decoration:line-through; cursor:pointer; } 
.imgtrombi { height:90px; width:62px; border-radius:9px; float:left; }
.infotrombi { float:right; padding-left: 5px;}
.senelt { color:white; text-decoration:none; border:1px solid grey; width:22%; padding: 3px; margin:9px; box-shadow: 3px 3px 5px white; display:inline flex; }
.senelt:hover { background-color: #C80947; }
.senelt a { color:white; text-decoration:none; }
.sennom { font-size: 1.1em; font-weight: bold; margin-bottom: 20px; }
.sendpt { color: yellow; }

.bouton { font-size:0.8em; background-color:#FFAA44; color:#882222; border-radius:20px; cursor:pointer; }
.quit { position:fixed; top:500px; }

#error { font-size:1.1em; color:#C80947; border:1px solid; text-align:center; margin:0 auto; width:33%; background-color:#FFCCCC; }
#version a { font-size:0.8em; color:#777777; position:fixed; bottom:5px; right:9px; text-decoration:none; }
}
</style>
</head>
<body onload="start()" style="background-color:black; user-select:none">
<script type="text/javascript">
//
//no framework; it's funnier to reinvent the wheel.
//pas de framework; c'est plus drôle de réinventer la roue.
//
 const DELAY_SHORT = 900;
 const DELAY_LONG = 4000;
 const NB_MAX_PROP = 20;
 const SCORE_1 = 0.75 * NB_MAX_PROP;  //(15/20)
 const SCORE_2 = 0.9 * NB_MAX_PROP;   //(18/20)
 //SCORE_3 = NB_MAX_PROP
 const NO_GROUP = "-TOUS-";
 const NO_FILTER = "-filtre-"; //lowercase
 const NBSP = "&nbsp;";
 const UTF8_CHECK_MARK = "&#x2705";  // pict. right answer
 const UTF8_CROSS_MARK = "&#x274C";  // pict. wrong answer

 var interval_ctrl;

 var tableau_senateurs = []; //objets "senateur"
 // objet senateur:
 // .nomcomplet
 // .nomtri
 // .id
 // .sexe
 // .groupe
 // .dpt

 var tableau_groupes = [];
 var tableau_bonrep = []; //indices:0..4
 var tableau_pastprop = [];

 var bonrep = 0;
 var score = 0;
 var scoremax = 0;
 var async_cpt = 0;
 var trombi_h = true;
 var trombi_f = true;

 
// refactoring / helpers
 function elt(nom_obj)  { return document.getElementById(nom_obj); }
 function xval(xmlelt)  { return xmlelt.childNodes[0].nodeValue; } //obsolete (XML)
 function id2img(id)    { return "https://www.senat.fr/senimg/" + id + ".jpg"; }
 function id2url(id)	{ return "https://www.senat.fr/senateur/" + id + ".html"}
 function show(nom_obj) { elt(nom_obj).style.display = ""; }
 function hide(nom_obj) { elt(nom_obj).style.display = "none"; }
 
 function compare_senateurs(sen1,sen2)
 {
	 return (sen1.nomtri>sen2.nomtri); //accents ?
 }

//////////////////////////
 
 function start()
 {
	ajax("https://www.nossenateurs.fr/senateurs/enmandat/json", parsing);
	//https://www.senat.fr/senateurs/sens_alpha.json
	//https://www.nossenateurs.fr/senateurs/enmandat/xml
 }
 
 function parsing(texte)
 {
	var jsonobj = JSON.parse(texte);
	var jsen = jsonobj['senateurs'];
	
	if (jsen.length < 200)
	{
		hide("loading");
		elt("error").innerHTML = "Nombre de sénateurs téléchargés (" + jsen.length + ") insuffisant.";
		show("error");
	}
	else
	{
		for (i=0; i<jsen.length; i++)
		{
			var senateur = new Object();
			senateur.nomcomplet = jsen[i]['senateur']['nom'];
			//normalize ?
			//doesn't work properly//
			/*var mots = xval(tableau_xmlnoms[i]).split(" ");
			//nom=dernier mot (sans éventuelle particule)
			var last = mots.length-1;
			mots[last] = mots[last].toLowerCase();
			mots[last] = mots[last].charAt(0).toUpperCase() + mots[last].slice(1);
			var nouvnom = "";
			for (j=0; j<mots.length; j++)
			{
				nouvnom = nouvnom + mots[j] + " ";
			}
			nouvnom = nouvnom.trim(); //retrait du dernier espace*/
			//contournement temporaire d'urgence
			if (senateur.nomcomplet=="Alain CAZABONNE")
			{
				senateur.nomcomplet="Alain Cazabonne";
			}
			if (senateur.nomcomplet=="Guylène PANTEL")
			{
				senateur.nomcomplet="Guylène Pantel";
			}
			
			senateur.nomtri = jsen[i]['senateur']['nom_de_famille'];
			senateur.nomtri = (senateur.nomtri).toLowerCase(); //traitement des accents ?
			senateur.sexe = jsen[i]['senateur']['sexe'];
			senateur.id = jsen[i]['senateur']['id_institution'];
			senateur.groupe = jsen[i]['senateur']['groupe_sigle'];
			senateur.dpt = jsen[i]['senateur']['nom_circo'];
			tableau_senateurs.push(senateur);
			if (tableau_groupes.indexOf(senateur.groupe)==-1)
			{
				tableau_groupes.push(senateur.groupe);
			}
		}
		
		tableau_senateurs.sort(compare_senateurs);
		
		
		async_cpt = 0;
		elt("loadinfo").innerHTML = "Préparation des données et téléchargement des photos..."
		interval_ctrl = setInterval(fill_trombi, 0);
	 }
 }
 
 function fill_trombi()
 {
	//fill trombi
	var i = async_cpt;
	elt("listsen").innerHTML += "<A HREF=\"" + id2url(tableau_senateurs[i].id) + "\" TARGET=\"_blank\"><div class=\"senelt\" id=\"" + tableau_senateurs[i].id + "\">"
			+ "<img class=\"imgtrombi\" src=\""	+ id2img(tableau_senateurs[i].id) + "\">"
			+ "<div class=\"infotrombi\"><div class=\"sennom\">" + tableau_senateurs[i].nomcomplet + "</div>"
			+ "<div class=\"sengrp\">" + tableau_senateurs[i].groupe + "</div>"
			+ "<div class=\"sendpt\">" + tableau_senateurs[i].dpt + "</div></div></A>";
	
	async_cpt++;
	if (async_cpt>=tableau_senateurs.length)
	{
		hide("loading");
		clearInterval(interval_ctrl);
		tableau_groupes.sort();
		var grp = elt("selgrp");
		grp.innerHTML = "<option value=\"\">" + NO_GROUP + "</option>";
		for (i=0; i< tableau_groupes.length; i++)
		{
			grp.innerHTML += "<option value=\"" + tableau_groupes[i] + "\">" + tableau_groupes[i] + "</option>"
		} 
		show("messen");
	}
 }

 function ajax(url,callback)
 {
	var httpRequest = new XMLHttpRequest();
	if (!httpRequest){ return false; }
	httpRequest.onreadystatechange=function()
	{
		try {
			if (httpRequest.readyState===XMLHttpRequest.DONE && httpRequest.status===200)
			{
				callback(httpRequest.responseText);
			}
		} catch(e){ return false; }
	}
	httpRequest.open('GET',url);
	httpRequest.send();
	return true;
 }

 function launch(numjeu)
 {
	hide("menu");
	show("quit");
	show("score");
	switch (numjeu) {
		case 1:
			show("game1");
			game1(-1);
			break
		case 2:
			show("game2");
			game2(-1);
			break;
		case 3:
			hide("messen");
			trombi_h = true;
			trombi_f = true;
			elt("filtre").value = NO_FILTER;
			show("trombi");
			break;
	}
 }
 
 function quit()
 {
	hide("game1");
	hide("game2");
	hide("trombi");
	hide("score");
	hide("quit");
	show("messen");
	show("menu");
 }
 
 function starscore(score)
 {
	var res = "";
	var stars = 0;
	const UTF8_STAR = "&#x2B50;";
	const UTF8_EMPTY_STAR = "&#x2606;";
	if (score>=SCORE_1) 	{ stars++; }
	if (score>=SCORE_2) 	{ stars++; }
	if (score>=NB_MAX_PROP) { stars++; }
	for (i=0; i<stars; i++)   { res += NBSP + UTF8_STAR; }
	for (i=0; i<3-stars; i++) {	res += NBSP + UTF8_EMPTY_STAR; }
	return res;
 }
 
 function game1(val)
 {
	hide("nomok");
	hide("imgindic");
	hide("nomno");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tableau_pastprop.length = 0;
	}
	elt("score").innerHTML = "PHOTO " + (scoremax+1) + "/" + NB_MAX_PROP + " - ";
	elt("score").innerHTML += "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=NB_MAX_PROP)
	{		
		hide("game1");
		show("menu");
		hide("quit");
	    elt("score").innerHTML = "SCORE FINAL = " + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
		
	var n = tableau_senateurs.length;
	var num1 = Math.floor(n*Math.random());
	var sexeref = tableau_senateurs[num1].sexe;
	var num2 = Math.floor(n*Math.random());
	var sexe = tableau_senateurs[num2].sexe;
	while ((num2==num1) || (sexe!=sexeref))
	{
		num2 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num2].sexe;
	}
	var num3 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num3].sexe;
	while ((num3==num2) || (num3==num1) || (sexe!=sexeref))
	{
		num3 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num3].sexe;
	}
	var num4 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num4].sexe;
	while ((num4==num3) || (num4==num2)|| (num4==num1) || (sexe!=sexeref))
	{
		num4 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num4].sexe;
	}
	var num5 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num5].sexe;
	while ((num5==num4) || (num5==num3) || (num5==num2) || (num5==num1) || (sexe!=sexeref))
	{
		num5 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num5].sexe;
	}
	//5 fausses réponses **différentes**
	elt("nom1").innerHTML= tableau_senateurs[num1].nomcomplet;
	elt("nom2").innerHTML= tableau_senateurs[num2].nomcomplet;
	elt("nom3").innerHTML= tableau_senateurs[num3].nomcomplet;
	elt("nom4").innerHTML= tableau_senateurs[num4].nomcomplet;
	elt("nom5").innerHTML= tableau_senateurs[num5].nomcomplet;
	tableau_bonrep[0] = num1;
	tableau_bonrep[1] = num2;
	tableau_bonrep[2] = num3;
	tableau_bonrep[3] = num4;
	tableau_bonrep[4] = num5;
	
	//écrasement avec la bonne réponse à un endroit (bonrep [1..5])) au hasard
	var vnum = 0;
	var prop_ok = true;
	do
	{
		vnum = Math.floor(n*Math.random());
		sexe = tableau_senateurs[vnum].sexe;
		while ((vnum==num5) || (vnum==num4) || (vnum==num3) || (vnum==num2) || (vnum==num1) || (sexe!=sexeref))
		{
			vnum = Math.floor(n*Math.random());
			sexe = tableau_senateurs[vnum].sexe;
		}
		prop_ok = true;
		for (i=0; i<tableau_pastprop.length; i++)
		{
			if (vnum==tableau_pastprop[i])
			{
				prop_ok = false;
			}
		}
	} while (!prop_ok);
	tableau_pastprop.push(vnum);

	bonrep = Math.floor(5*Math.random())+1;
	elt("img0").src = id2img(tableau_senateurs[vnum].id);
	var varnom = "nom" + bonrep;
	elt(varnom).innerHTML = tableau_senateurs[vnum].nomcomplet;
	elt("nomok").innerHTML = elt(varnom).innerHTML;	
	show("nom1");
	show("nom2");
	show("nom3");
	show("nom4");
	show("nom5");
 }
 
 function verif1(rep)
 {
	hide("nom1");
	hide("nom2");
	hide("nom3");
	hide("nom4");
	hide("nom5");
	show("nomok");
	var delay = DELAY_SHORT;
	if (rep!==bonrep) {
		delay = DELAY_LONG;
		elt("nomno").innerHTML = UTF8_CROSS_MARK + NBSP + elt("nom"+rep).innerHTML;
		show("nomno");
		elt("imgindic").src = id2img(tableau_senateurs[tableau_bonrep[rep-1]].id);
		show("imgindic");
	}
	else
	{
		elt("nomok").innerHTML = UTF8_CHECK_MARK + NBSP + elt("nomok").innerHTML;
	}
	setTimeout(function(){ game1(rep); }, delay);
 }

 function game2(val)
 {
 	hide("imgok");
	hide("nomindic");
	hide("imgno");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tableau_pastprop.length = 0;
	}
	elt("score").innerHTML = "NOM " + (scoremax+1) + "/" + NB_MAX_PROP + " - ";
	elt("score").innerHTML += "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=20)
	{		
		hide("game2");
		show("menu");
		hide("quit");
		elt("score").innerHTML = "SCORE FINAL = " + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
	
	var n = tableau_senateurs.length;
	var num1 = Math.floor(n*Math.random());
	var sexeref = tableau_senateurs[num1].sexe;
	var num2 = Math.floor(n*Math.random());
	var sexe = tableau_senateurs[num2].sexe;
	while ((num2==num1) || (sexe!=sexeref))
	{
		num2 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num2].sexe;
	}
	var num3 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num3].sexe;
	while ((num3==num2) || (num3==num1) || (sexe!=sexeref))
	{
		num3 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num3].sexe;
	}
	var num4 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num4].sexe;
	while ((num4==num3) || (num4==num2)|| (num4==num1) || (sexe!=sexeref))
	{
		num4 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num4].sexe;
	}
	var num5 = Math.floor(n*Math.random());
	sexe = tableau_senateurs[num5].sexe;
	while ((num5==num4) || (num5==num3) || (num5==num2) || (num5==num1) || (sexe!=sexeref))
	{
		num5 = Math.floor(n*Math.random());
		sexe = tableau_senateurs[num5].sexe;
	}
	//5 fausses réponses **différentes**
	elt("img1").src = id2img(tableau_senateurs[num1].id);
	elt("img2").src = id2img(tableau_senateurs[num2].id);
	elt("img3").src = id2img(tableau_senateurs[num3].id);
	elt("img4").src = id2img(tableau_senateurs[num4].id);
	elt("img5").src = id2img(tableau_senateurs[num5].id);
	tableau_bonrep[0] = num1;
	tableau_bonrep[1] = num2;
	tableau_bonrep[2] = num3;
	tableau_bonrep[3] = num4;
	tableau_bonrep[4] = num5;
	
	//écrasement avec la bonne réponse à un endroit ("bonrep" [1..5]) au hasard
	var vnum = 0;
	var prop_ok = true;
	do
	{
		vnum = Math.floor(n*Math.random());
		sexe = tableau_senateurs[vnum].sexe;
		while ((vnum==num5) || (vnum==num4) || (vnum==num3) || (vnum==num2) || (vnum==num1) || (sexe!=sexeref))
		{
			vnum = Math.floor(n*Math.random());
			sexe = tableau_senateurs[vnum].sexe;
		}
		prop_ok = true;
		for (i=0; i<tableau_pastprop.length; i++)
		{
			if (vnum==tableau_pastprop[i])
			{
				prop_ok = false;
			}
		}
	} while (!prop_ok);
	tableau_pastprop.push(vnum);
	
	bonrep = Math.floor(5*Math.random())+1;
	elt("nom0").innerHTML= tableau_senateurs[vnum].nomcomplet;
	var varimg = "img" + bonrep;
	elt(varimg).src = id2img(tableau_senateurs[vnum].id);
	elt("imgok").src = elt(varimg).src;
	show("img1");
	show("img2");
	show("img3");
	show("img4");
	show("img5");
 }
 
 function verif2(rep)
 {
 	hide("img1");
	hide("img2");
	hide("img3");
	hide("img4");
	hide("img5");
	show("imgok");
	var delay = DELAY_SHORT;
	if (rep!==bonrep) {
		delay = DELAY_LONG;
		elt("imgno").src = elt("img"+rep).src;
		show("imgno");
		elt("nomindic").innerHTML = tableau_senateurs[tableau_bonrep[rep-1]].nomcomplet;
		show("nomindic");
	}
	setTimeout(function(){ game2(rep); }, delay);
 }

 function initfilter()
 {
	if (elt("filtre").value == NO_FILTER)
	{
		elt("filtre").value = "";
	}
 }

 function majtrombi(action)
 {
	var filtre = elt("filtre").value.toLowerCase(); //perf
	var filgrp = elt("selgrp").options[elt("selgrp").selectedIndex].text;
	if (action==1)//hommes
	{
		trombi_h = !trombi_h;
	}
	if (action==2)//femmes
	{
		trombi_f = !trombi_f;
	}
	
	if (trombi_h)
	{
		elt("hommes").className = "chactif";
	}
	else
	{
		elt("hommes").className = "chinactif";
	}
	if (trombi_f)
	{
		elt("femmes").className = "chactif";
	}
	else
	{
		elt("femmes").className = "chinactif";
	}

	for (i=0; i<tableau_senateurs.length; i++)
	{
		if (tableau_senateurs[i].sexe == "H")
		{
			if (trombi_h)
			{
				show(tableau_senateurs[i].id);
			}
			else
			{
				hide(tableau_senateurs[i].id);
			}				
		}
		else //F
		{
			if (trombi_f)
			{
				show(tableau_senateurs[i].id);
			}
			else
			{
				hide(tableau_senateurs[i].id);
			}
		}
		
		if (filtre!= NO_FILTER && filtre!=""
)
		{
			if ((!(tableau_senateurs[i].nomcomplet.toLowerCase()).includes(filtre)))
			{
				hide(tableau_senateurs[i].id);
			}
		}
		if (filgrp != NO_GROUP)
		{
			if (tableau_senateurs[i].groupe != filgrp)
			{
				hide(tableau_senateurs[i].id);
			}
		}
	}
	show("vide");
	for (i=0; i<tableau_senateurs.length; i++)
	{
		if (elt(tableau_senateurs[i].id).style.display == "")
		{
			hide("vide");
			break;
		}
	}
 }
</script>
<BR>
<div id="loading">
<p align="center"><img src="senanim.gif" style="vertical-align:middle" width="50" height="52" ALT="Logo">
<span id="loadinfo">Téléchargement des données...</span>
</div> <!--/loading-->

<div id="messen" style="display:none">

<div id="score" style="display:none"></div>

<div id="menu">
<div id="c1" onclick="launch(1)" class="gamesel"
		title="Pour 1 photo, 5 noms. Il faut trouver le bon.">"Quel nom&nbsp;?"</div>
<div id="c2" onclick="launch(2)" class="gamesel"
	title="Pour 1 nom, 5 photos. Il faut trouver la bonne.">"Quelle photo&nbsp;?"</div>
<div id="c3" onclick="launch(3)" class="gamesel"
	title="Trombinoscope interactif">Trombi</div>
</div> <!--/menu-->

<div id="game1" style="display:none">
<img id="img0">
<div id="nom1" class="nomsen" onclick="verif1(1)"></div>
<div id="nom2" class="nomsen" onclick="verif1(2)"></div>
<div id="nom3" class="nomsen" onclick="verif1(3)"></div>
<div id="nom4" class="nomsen" onclick="verif1(4)"></div>
<div id="nom5" class="nomsen" onclick="verif1(5)"></div>
<div id="nomok"></div>
<div id="nomno"></div><img id="imgindic">
</div> <!--/game1-->

<div id="game2" style="display:none">
<div id="nom0"></div>
<img id="img1" class="imgsen" onclick="verif2(1)">
<img id="img2" class="imgsen" onclick="verif2(2)">
<img id="img3" class="imgsen" onclick="verif2(3)">
<img id="img4" class="imgsen" onclick="verif2(4)">
<img id="img5" class="imgsen" onclick="verif2(5)">
<img id="imgok">
<img id="imgno">&nbsp;<span id="nomindic"></span>
</div> <!--/game2-->

<button id="quit" style="display:none" onclick="quit()" class="bouton quit">Abandonner</button>
</div> <!--/messen-->

<div id="error" style="display:none"></div>
<div id="version"><A HREF="https://github.com/gjandot/mes_sen/">Version 0.009</A></div>
<!-- G. JANDOT / 08/05/2021 -->
<div id="trombi" style="display:none">
<div>
<span id="hommes" onclick="majtrombi(1)" class="chactif" unselectable="on">Hommes</span>&nbsp;
<span id="femmes" onclick="majtrombi(2)" class="chactif" unselectable="on">Femmes</span>&nbsp;
<select id="selgrp" onchange="majtrombi(0)"></select>
<input id="filtre" type="text" oninput="majtrombi(0)" onfocus="initfilter()">
<button id="return" onclick="quit()" class="bouton">Retour</button>
</div>
<div id="listsen"></div>
<div id="vide" class="senelt" style="display:none">Aucun résultat.</div>
</div> <!--/trombi-->

</body>
</html>
