<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--IDs
* numéro de photo sous forme d'une barre de progression
* mode "défi" : tous les sénateurs. Arrêt à la première erreur.
* plusieurs difficultés (nombres de propositions)
* photos non sénateurs (secret guest stars)
* délai de réponse max
* recherche de combinaisons spéciales (prénoms identiques...) ?
* jeu 3 : Quel Groupe ?
* vérifier/attendre le chargement des images ?
* prétéléchargement de toutes les images ?
* problématique des images absentes (début de mandat)
*/
-->
<title>Mes-Sen</title>
<style>
#messen { height:500px; width:850px; margin:auto; padding:9px; border-radius:20px; background-color:#C80947; }
#loading { font-size:1.2em; color: white; }
.gamesel { position:relative; height:120px; width:250px; color:white; font-size:1.5em; cursor:pointer; background-color:blue;
			border:3px solid black; margin:10px; border-radius:25px; text-align:center; line-height:120px; }
.gamesel:hover { border:3px solid yellow; background-color:white; color:blue; font-size:2em; }
#score { border:1px solid white; color:lightblue; background-color:blue; margin:9px; padding:3px; }

#img0 { height:225px; width:155px; margin:9px; border:1px solid black; border-radius:9px; }
.nomsen { font-size:1.2em; color:white; cursor:pointer; }
.nomsen:hover { font-size:1.4em; color:yellow; }
#nomok { font-size:1.5em; color:#44FF44; }
#nomno { font-size:1.1em; color:#FF8888; }
#imgindic { height:90px; width:62px; border:3px solid red; border-radius:9px;}

#nom0 { font-size:1.4em; color:white; margin-top:25px; padding-bottom:25px; cursor:pointer; }
.imgsen { height:225px; width:155px; border:1px solid black; border-radius:9px; margin:3px; cursor:pointer; }
.imgsen:hover { transform:scale(1.1); border:3px solid yellow; margin:1px; } 
#imgok { height:247px; width:170px; border:5px solid green; border-radius:15px; }
#imgno { height:90px; width:62px; border:3px solid red; margin-left:9px; border-radius:9px; }
#nomindic { font-size:1.1em; color:#FF8888; }

#quit { font-size:0.8em; background-color:#FFAA44; color:#882222; border-radius:20px; position:fixed; top:500px; cursor:pointer; }
#error { font-size:1.1em; color:#C80947; border:1px solid; text-align:center; margin:0 auto; width:33%; }
#version a { font-size:0.8em; color:#777777; position:fixed; bottom:5px; text-decoration:none; }</style>
</head>
<body onload="start()" style="background-color:black">
<script type="text/javascript">
//
//no framework; it's funnier to reinvent the wheel.
//pas de framework; c'est plus drôle de réinventer la roue.
//
 const DELAY_SHORT = 900;
 const DELAY_LONG = 4000;
 const NB_MAX_PROP = 20;
 const SCORE_1 = 0.75 * NB_MAX_PROP;  //(15/20)
 const SCORE_2 = 0.9 * NB_MAX_PROP;   //(18/20)
 //SCORE_3 = NB_MAX_PROP
 const NBSP = "&nbsp;";
 const UTF8_CHECK_MARK = "&#x2705";  // pict. right answer
 const UTF8_CROSS_MARK = "&#x274C";  // pict. wrong answer

 var tableau_xml_noms = [];
 var tableau_noms = [];
 var tableau_images = [];
 var tableau_sexes = [];
 var tableau_bonrep = []; //indices:0..4
 var tableau_pastprop = [];
 var bonrep = 0;
 var score = 0;
 var scoremax = 0;
 
// refactoring / helpers
 function elt(nom_obj)  { return document.getElementById(nom_obj); }
 function xval(xmlelt)  { return xmlelt.childNodes[0].nodeValue; }
 function id2img(id)    { return "http://www.senat.fr/senimg/" + id + ".jpg"; }
 function show(nom_obj) { elt(nom_obj).style.display = ""; }
 function hide(nom_obj) { elt(nom_obj).style.display = "none"; }

//////////////////////////
 
 function start()
 {
  ajax("https://www.nossenateurs.fr/senateurs/enmandat/xml", parsing);
  //https://www.nossenateurs.fr/senateurs/enmandat/json
  //https://data.senat.fr/data/senateurs/ODSEN_GENERAL.json
 }

 function parsing(texte)
 {
	var parser = new DOMParser();
	var xmlDoc = parser.parseFromString(texte,"text/xml");
	
	tableau_xmlnoms = xmlDoc.getElementsByTagName("nom");
	tableau_images = xmlDoc.getElementsByTagName("id_institution");
	tableau_sexes = xmlDoc.getElementsByTagName("sexe");

	if (tableau_xmlnoms.length < 200)
	{
		elt("error").innerHTML = "Nombre de sénateurs téléchargés insuffisant.";
		show("error");
	}
	else
	{
		//normalisation des noms (certains sont en entièrement en majuscules)
		for (i=0; i<tableau_xmlnoms.length; i++)
		{
			var mots = xval(tableau_xmlnoms[i]).split(" ");
			//nom=dernier mot (sans éventuelle particule)
			var last = mots.length-1;
			mots[last] = mots[last].toLowerCase();
			mots[last] = mots[last].charAt(0).toUpperCase() + mots[last].slice(1);
			var nouvnom = "";
			for (j=0; j<mots.length; j++)
			{
				nouvnom = nouvnom + mots[j] + " ";
			}
			tableau_noms.push(nouvnom.trim());
			console.log(nouvnom.trim());
		}

		show("messen");
	}
	hide("loading");
 }

 function ajax(url,callback)
 {
	var httpRequest=new XMLHttpRequest();
	if (!httpRequest){ return false; }
	httpRequest.onreadystatechange=function()
	{
		try {
			if (httpRequest.readyState===XMLHttpRequest.DONE && httpRequest.status===200)
			{
				callback(httpRequest.responseText);
			}
		} catch(e){ return false;}
	}
	httpRequest.open('GET',url);
	httpRequest.send();
	return true;
 }

 function launch(numjeu)
 {
	hide("game_select");
	show("quit");
	show("score");
	if (numjeu==1)
	{
		show("game1");
		game1(-1);
	}
	else//numjeu==2
	{
	show("game2");
	game2(-1);
	}
 }
 
 function quit()
 {
	hide("quit");
	hide("game1");
	hide("game2");
	hide("score");
	show("game_select");
 }
 
 function starscore(score)
 {
	var res = "";
	var stars = 0;
	const UTF8_STAR = "&#x2B50;";
	const UTF8_EMPTY_STAR = "&#x2606;";
	if (score>=SCORE_1) 	{ stars++; }
	if (score>=SCORE_2) 	{ stars++; }
	if (score>=NB_MAX_PROP) { stars++; }
	for (i=0; i<stars; i++)   { res += NBSP + UTF8_STAR; }
	for (i=0; i<3-stars; i++) {	res += NBSP + UTF8_EMPTY_STAR; }
	return res;
 }
 
 function game1(val)
 {
	hide("nomok");
	hide("imgindic");
	hide("nomno");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tableau_pastprop.length = 0;
	}
	elt("score").innerHTML = "PHOTO " + (scoremax+1) + "/" + NB_MAX_PROP + " - ";
	elt("score").innerHTML += "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=NB_MAX_PROP)
	{		
		hide("game1");
		show("game_select");
		hide("quit");
	    elt("score").innerHTML = "SCORE FINAL = " + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
		
	var n = tableau_noms.length;
	var num1 = Math.floor(n*Math.random());
	var sexeref = xval(tableau_sexes[num1]);
	var num2 = Math.floor(n*Math.random());
	var sexe = xval(tableau_sexes[num2]);
	while ((num2==num1) || (sexe!=sexeref))
	{
		num2 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num2]);
	}
	var num3 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num3]);
	while ((num3==num2) || (num3==num1) || (sexe!=sexeref))
	{
		num3 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num3]);
	}
	var num4 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num4]);
	while ((num4==num3) || (num4==num2)|| (num4==num1) || (sexe!=sexeref))
	{
		num4 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num4]);
	}
	var num5 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num5]);
	while ((num5==num4) || (num5==num3) || (num5==num2) || (num5==num1) || (sexe!=sexeref))
	{
		num5 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num5]);
	}
	//5 fausses réponses **différentes**
	elt("nom1").innerHTML= tableau_noms[num1];
	elt("nom2").innerHTML= tableau_noms[num2];
	elt("nom3").innerHTML= tableau_noms[num3];
	elt("nom4").innerHTML= tableau_noms[num4];
	elt("nom5").innerHTML= tableau_noms[num5];
	tableau_bonrep[0] = num1;
	tableau_bonrep[1] = num2;
	tableau_bonrep[2] = num3;
	tableau_bonrep[3] = num4;
	tableau_bonrep[4] = num5;
	
	//écrasement avec la bonne réponse à un endroit (bonrep [1..5])) au hasard
	var vnum = 0;
	var prop_ok = true;
	do
	{
		vnum = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[vnum]);
		while ((vnum==num5) || (vnum==num4) || (vnum==num3) || (vnum==num2) || (vnum==num1) || (sexe!=sexeref))
		{
			vnum = Math.floor(n*Math.random());
			sexe = xval(tableau_sexes[vnum]);
		}
		prop_ok = true;
		for (i=0; i<tableau_pastprop.length; i++)
		{
			if (vnum==tableau_pastprop[i])
			{
				prop_ok = false;
			}
		}
	} while (!prop_ok);
	tableau_pastprop.push(vnum);

	bonrep = Math.floor(5*Math.random())+1;
	elt("img0").src = id2img(xval(tableau_images[vnum]));
	var varnom = "nom" + bonrep;
	elt(varnom).innerHTML = tableau_noms[vnum];
	elt("nomok").innerHTML = elt(varnom).innerHTML;	
	show("nom1");
	show("nom2");
	show("nom3");
	show("nom4");
	show("nom5");
 }
 
 function verif1(rep)
 {
	hide("nom1");
	hide("nom2");
	hide("nom3");
	hide("nom4");
	hide("nom5");
	show("nomok");
	var delay = DELAY_SHORT;
	if (rep!==bonrep) {
		delay = DELAY_LONG;
		elt("nomno").innerHTML = UTF8_CROSS_MARK + NBSP + elt("nom"+rep).innerHTML;
		show("nomno");
		elt("imgindic").src = id2img(xval(tableau_images[tableau_bonrep[rep-1]]));
		show("imgindic");
	}
	else
	{
		elt("nomok").innerHTML = UTF8_CHECK_MARK + NBSP + elt("nomok").innerHTML;
	}
	setTimeout(function(){ game1(rep); }, delay);
 }

 function game2(val)
 {
 	hide("imgok");
	hide("nomindic");
	hide("imgno");
 
	//val : -1 pour initialisation
	if (val>-1)
	{
		scoremax = scoremax + 1;
		if (val==bonrep)
		{
			score = score + 1;
		}
	}
	else
	{
		score = 0;
		scoremax = 0;
		tableau_pastprop.length = 0;
	}
	elt("score").innerHTML = "NOM " + (scoremax+1) + "/" + NB_MAX_PROP + " - ";
	elt("score").innerHTML += "SCORE = " + score + "/" + scoremax + " - " + starscore(score);
	
	if (scoremax>=20)
	{		
		hide("game2");
		show("game_select");
		hide("quit");
		elt("score").innerHTML = "SCORE FINAL = " + score + "/" + scoremax + " - " + starscore(score);
		return;
	}
	
	var n = tableau_noms.length;
	var num1 = Math.floor(n*Math.random());
	var sexeref = xval(tableau_sexes[num1]);
	var num2 = Math.floor(n*Math.random());
	var sexe = xval(tableau_sexes[num2]);
	while ((num2==num1) || (sexe!=sexeref))
	{
		num2 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num2]);
	}
	var num3 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num3]);
	while ((num3==num2) || (num3==num1) || (sexe!=sexeref))
	{
		num3 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num3]);
	}
	var num4 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num4]);
	while ((num4==num3) || (num4==num2)|| (num4==num1) || (sexe!=sexeref))
	{
		num4 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num4]);
	}
	var num5 = Math.floor(n*Math.random());
	sexe = xval(tableau_sexes[num5]);
	while ((num5==num4) || (num5==num3) || (num5==num2) || (num5==num1) || (sexe!=sexeref))
	{
		num5 = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[num5]);
	}
	//5 fausses réponses **différentes**
	elt("img1").src = id2img(xval(tableau_images[num1]));
	elt("img2").src = id2img(xval(tableau_images[num2]));
	elt("img3").src = id2img(xval(tableau_images[num3]));
	elt("img4").src = id2img(xval(tableau_images[num4]));
	elt("img5").src = id2img(xval(tableau_images[num5]));
	tableau_bonrep[0] = num1;
	tableau_bonrep[1] = num2;
	tableau_bonrep[2] = num3;
	tableau_bonrep[3] = num4;
	tableau_bonrep[4] = num5;
	
	//écrasement avec la bonne réponse à un endroit ("bonrep" [1..5]) au hasard
	var vnum = 0;
	var prop_ok = true;
	do
	{
		vnum = Math.floor(n*Math.random());
		sexe = xval(tableau_sexes[vnum]);
		while ((vnum==num5) || (vnum==num4) || (vnum==num3) || (vnum==num2) || (vnum==num1) || (sexe!=sexeref))
		{
			vnum = Math.floor(n*Math.random());
			sexe = xval(tableau_sexes[vnum]);
		}
		prop_ok = true;
		for (i=0; i<tableau_pastprop.length; i++)
		{
			if (vnum==tableau_pastprop[i])
			{
				prop_ok = false;
			}
		}
	} while (!prop_ok);
	tableau_pastprop.push(vnum);
	
	bonrep = Math.floor(5*Math.random())+1;
	elt("nom0").innerHTML= tableau_noms[vnum];
	var varimg = "img" + bonrep;
	elt(varimg).src = id2img(xval(tableau_images[vnum]));
	elt("imgok").src = elt(varimg).src;
	show("img1");
	show("img2");
	show("img3");
	show("img4");
	show("img5");
 }
 
 function verif2(rep)
 {
 	hide("img1");
	hide("img2");
	hide("img3");
	hide("img4");
	hide("img5");
	show("imgok");
	var delay = DELAY_SHORT;
	if (rep!==bonrep) {
		delay = DELAY_LONG;
		elt("imgno").src = elt("img"+rep).src;
		show("imgno");
		elt("nomindic").innerHTML = tableau_noms[tableau_bonrep[rep-1]];
		show("nomindic");
	}
	setTimeout(function(){ game2(rep); }, delay);
 }

</script>
<BR>
<div id="loading">
<P align="center"><img src="senanim.gif" style="vertical-align:middle" width="50" height="52" ALT="Logo">
Téléchargement des informations relatives aux sénateurs...</p>
</div> <!--/loading-->

<div id="messen" style="display:none">

<div id="score" style="display:none"></div>

<div id="game_select">
<div id="c_game1" onclick="launch(1)" class="gamesel"
		title="Pour 1 nom, 5 photos. Il faut trouver la bonne.">Quel nom&nbsp;?</div>
<div id="c_game2" onclick="launch(2)" class="gamesel"
	title="Pour 1 photo, 5 noms. Il faut trouver le bon.">Quelle photo&nbsp;?</div>
</div> <!--/game_select-->

<div id="game1" style="display:none">
<img id="img0">
<div id="nom1" class="nomsen" onclick="verif1(1)"></div>
<div id="nom2" class="nomsen" onclick="verif1(2)"></div>
<div id="nom3" class="nomsen" onclick="verif1(3)"></div>
<div id="nom4" class="nomsen" onclick="verif1(4)"></div>
<div id="nom5" class="nomsen" onclick="verif1(5)"></div>
<div id="nomok"></div>
<div id="nomno"></div><img id="imgindic">
</div> <!--/game1-->

<div id="game2" style="display:none">
<div id="nom0"></div>
<img id="img1" class="imgsen" onclick="verif2(1)">
<img id="img2" class="imgsen" onclick="verif2(2)">
<img id="img3" class="imgsen" onclick="verif2(3)">
<img id="img4" class="imgsen" onclick="verif2(4)">
<img id="img5" class="imgsen" onclick="verif2(5)">
<img id="imgok">
<img id="imgno">&nbsp;<span id="nomindic"></span>
</div> <!--/game2-->

<button id="quit" style="display:none" onclick="quit()">Abandonner</button>
</div> <!--/messen-->

<div id="error" style="display:none"></div>
<div id="version"><A HREF="https://github.com/gjandot/mes_sen/">Version 0.006</A></div>
<!-- G. JANDOT / 04/05/2021 -->
</body>
</html>
